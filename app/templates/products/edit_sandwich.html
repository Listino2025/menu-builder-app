{% extends "base.html" %}

{% block title %}Modifica Ricetta - Menu Builder{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Header -->
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-pencil me-2 text-primary"></i>Modifica Ricetta
                    </h1>
                    <p class="text-muted mb-0">{{ product.name }}</p>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('main.product_detail', id=product.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Torna al Prodotto
                    </a>
                    <a href="{{ url_for('main.products') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-list me-1"></i>Tutti i Prodotti
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <form method="POST" id="sandwich-form" class="needs-validation" novalidate>
        <div class="row">
            <!-- Ingredients Selector -->
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-basket me-2"></i>Ingredienti
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Search Bar -->
                        <div class="p-3 border-bottom">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" placeholder="Cerca ingredienti..." 
                                       id="ingredient-search" data-search="ingredients">
                            </div>
                        </div>
                        
                        <!-- Category Tabs -->
                        <div class="ingredient-categories">
                            <nav class="nav nav-pills nav-fill border-bottom p-2" id="category-tabs">
                                <button class="nav-link active btn-sm" type="button" data-category="all">Tutti</button>
                                {% for category in ingredients_by_category.keys() %}
                                <button class="nav-link btn-sm" type="button" data-category="{{ category }}">
                                    {{ category.replace('_', ' ').title() }}
                                </button>
                                {% endfor %}
                            </nav>
                        </div>
                        
                        <!-- Ingredients List -->
                        <div class="ingredients-list p-3" id="ingredients-list" style="max-height: 500px; overflow-y: auto;">
                            {% for category, ingredients in ingredients_by_category.items() %}
                            <div class="ingredient-category mb-3" data-category="{{ category }}">
                                <h6 class="text-muted text-uppercase fw-bold mb-2">
                                    <i class="bi bi-{{ 'bread-slice' if category == 'BASE' else 'egg-fried' if category == 'PROTEIN' else 'circle' if category == 'CHEESE' else 'flower2' if category == 'VEGETABLE' else 'droplet' if category == 'SAUCE' else 'box' }} me-1"></i>
                                    {{ category.replace('_', ' ').title() }}
                                </h6>
                                {% for ingredient in ingredients %}
                                <div class="ingredient-item mb-2 {{ 'selected' if ingredient.id in current_ingredients.keys() else '' }}"
                                     data-ingredient-id="{{ ingredient.id }}"
                                     data-ingredient-name="{{ ingredient.name }}"
                                     data-ingredient-price="{{ ingredient.price_per_unit }}"
                                     data-ingredient-unit="{{ ingredient.unit_type }}"
                                     data-ingredient-category="{{ ingredient.category }}"
                                     data-searchable="ingredients"
                                     draggable="true">
                                    <div class="d-flex align-items-center">
                                        <div class="drag-handle me-2">
                                            <i class="bi bi-grip-vertical text-muted"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-medium">{{ ingredient.name }}</div>
                                            <small class="text-muted">
                                                ‚Ç¨{{ "%.7f"|format(ingredient.price_per_unit) }} / {{ ingredient.unit_type }}
                                                {% if ingredient.wrin_code %}
                                                ‚Ä¢ {{ ingredient.wrin_code }}
                                                {% endif %}
                                            </small>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary add-ingredient"
                                                data-ingredient-id="{{ ingredient.id }}">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sandwich Builder -->
            <div class="col-lg-5 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-stack me-2"></i>Costruttore Ricetta
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Visual Sandwich Preview -->
                        <div class="sandwich-preview mb-3" id="sandwich-preview">
                            <div class="sandwich-visual text-center">
                                <div class="empty-sandwich py-5">
                                    <i class="bi bi-burger display-4 text-muted"></i>
                                    <p class="text-muted mt-2">Ingredienti caricati dalla ricetta esistente</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ingredients Builder Area -->
                        <div class="sandwich-builder" id="sandwich-builder">
                            <!-- Existing ingredients will be loaded here by JavaScript -->
                        </div>
                        
                        <!-- Build Instructions -->
                        <div class="alert alert-warning mt-3">
                            <h6 class="alert-heading">
                                <i class="bi bi-exclamation-triangle me-1"></i>Modifica Ricetta Esistente
                            </h6>
                            <ul class="mb-0 small">
                                <li>Puoi modificare le quantit√† degli ingredienti esistenti</li>
                                <li>Puoi aggiungere o rimuovere ingredienti</li>
                                <li><strong>ATTENZIONE:</strong> Le modifiche influenzeranno tutti i menu che usano questa ricetta</li>
                                <li>Il codice prodotto automatico sar√† preservato</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Product Details & Cost Calculator -->
            <div class="col-lg-3 mb-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle me-2"></i>Dettagli Prodotto
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Nome Ricetta *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ product.name }}" required>
                            <div class="invalid-feedback">
                                Inserisci un nome per la ricetta.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="product_code_id" class="form-label">ID Codice Prodotto *</label>
                            <input type="text" class="form-control" id="product_code_id" name="product_code_id" 
                                   value="{{ product.product_code }}" required readonly>
                            <div class="invalid-feedback">
                                L'ID del codice prodotto non pu√≤ essere modificato.
                            </div>
                            <small class="text-muted">Generato automaticamente - non modificabile</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="restaurant_id" class="form-label">ID Ristorante *</label>
                            <input type="text" class="form-control" id="restaurant_id" name="restaurant_id" 
                                   value="{{ product.restaurant_id or '' }}" 
                                   placeholder="es. REST_ROMA_001 o SITE_12345" required>
                            <div class="invalid-feedback">
                                Inserisci l'ID univoco del ristorante.
                            </div>
                            <small class="text-muted">Identificativo univoco del ristorante per prezzi specifici per sito</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="delivery_price_id" class="form-label">ID Prezzo Delivery *</label>
                            <input type="text" class="form-control" id="delivery_price_id" name="delivery_price_id" 
                                   value="{{ product.delivery_price_id or '' }}" required>
                            <div class="invalid-feedback">
                                Inserisci l'ID del prezzo prodotto Delivery.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="selling_price" class="form-label">Prezzo di Vendita (‚Ç¨) *</label>
                            <div class="input-group">
                                <span class="input-group-text">‚Ç¨</span>
                                <input type="number" class="form-control" id="selling_price" name="selling_price" 
                                       value="{{ product.selling_price or '' }}" step="0.0000001" min="0" max="999.9999999" required data-calculate-cost>
                            </div>
                            <div class="invalid-feedback">
                                Inserisci un prezzo di vendita valido.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="food_paper_cost_total" class="form-label">Food + Paper Cost Totale (‚Ç¨) *</label>
                            <div class="input-group">
                                <span class="input-group-text">‚Ç¨</span>
                                <input type="number" class="form-control" id="food_paper_cost_total" name="food_paper_cost_total" 
                                       value="{{ product.food_paper_cost_total or '' }}" step="0.0000001" min="0" max="999.9999999" required>
                            </div>
                            <div class="invalid-feedback">
                                Inserisci il costo totale Food + Paper.
                            </div>
                        </div>
                        
                        <!-- Hidden ingredient inputs (populated by JavaScript) -->
                        <div id="ingredient-inputs"></div>
                    </div>
                </div>
                
                <!-- Cost Calculator -->
                <div class="card cost-calculator text-white">
                    <div class="card-body text-center">
                        <h6 class="card-title text-white">
                            <i class="bi bi-calculator me-2"></i>Analisi Costi
                        </h6>
                        
                        <div class="cost-display" id="total-cost">‚Ç¨{{ "%.7f"|format(product.total_cost) }}</div>
                        <small class="opacity-75">Costo Totale</small>
                        
                        <hr class="my-3 opacity-50">
                        
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="profit-display" id="gross-profit">‚Ç¨{{ "%.2f"|format(product.gross_profit or 0) }}</div>
                                <small class="opacity-75">Profitto Lordo</small>
                            </div>
                            <div class="col-6">
                                <div class="profit-display" id="profit-percentage">{{ "%.1f"|format(product.gross_profit_percent or 0) }}%</div>
                                <small class="opacity-75">Margine</small>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <small class="opacity-75">
                                <span id="ingredient-count">{{ product.ingredients.count() }}</span> ingredienti selezionati
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-grid gap-2 mt-3">
                    <button type="submit" class="btn btn-primary btn-lg" id="save-sandwich">
                        <i class="bi bi-check-circle me-2"></i>Salva Modifiche
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="resetToOriginal()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Ripristina Originale
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Existing ingredient data for editing
const existingIngredients = {{ current_ingredients | tojson }};
const productName = "{{ product.name }}";

class SandwichEditor {
    constructor() {
        this.selectedIngredients = new Map();
        this.originalIngredients = new Map();
        this.totalCost = 0;
        this.init();
        this.loadExistingIngredients();
    }
    
    init() {
        this.setupEventListeners();
        this.setupDragAndDrop();
        this.setupCategoryTabs();
    }
    
    loadExistingIngredients() {
        // Load existing ingredients from the product
        Object.entries(existingIngredients).forEach(([ingredientId, quantity]) => {
            const ingredientElement = document.querySelector(`[data-ingredient-id="${ingredientId}"]`);
            if (ingredientElement) {
                const ingredient = {
                    id: ingredientId,
                    name: ingredientElement.dataset.ingredientName,
                    price: parseFloat(ingredientElement.dataset.ingredientPrice),
                    unit: ingredientElement.dataset.ingredientUnit,
                    category: ingredientElement.dataset.ingredientCategory
                };
                
                this.selectedIngredients.set(ingredientId, { 
                    ...ingredient, 
                    quantity: quantity,
                    originalUnit: ingredient.unit,
                    displayUnit: ingredient.unit 
                });
                this.originalIngredients.set(ingredientId, { ...ingredient, quantity: quantity });
                this.renderSandwichLayer(ingredient, quantity);
                ingredientElement.classList.add('selected');
            }
        });
        
        this.updateCostCalculation();
        this.updateFormInputs();
        this.updateVisualPreview();
    }
    
    // Copy the same methods from create_sandwich.html but with modifications for editing
    setupEventListeners() {
        // Add ingredient buttons
        document.querySelectorAll('.add-ingredient').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const ingredientId = e.target.closest('.add-ingredient').dataset.ingredientId;
                this.addIngredient(ingredientId);
            });
        });
        
        // Search functionality
        const searchInput = document.getElementById('ingredient-search');
        searchInput.addEventListener('input', this.debounce(this.searchIngredients.bind(this), 300));
        
        // Selling price input
        const sellingPriceInput = document.getElementById('selling_price');
        sellingPriceInput.addEventListener('input', this.calculateProfit.bind(this));
        
        // Form validation
        const form = document.getElementById('sandwich-form');
        form.addEventListener('submit', this.validateAndSubmit.bind(this));
    }
    
    setupDragAndDrop() {
        document.querySelectorAll('.ingredient-item').forEach(item => {
            item.addEventListener('dragstart', this.handleDragStart.bind(this));
        });
        
        const sandwichBuilder = document.getElementById('sandwich-builder');
        sandwichBuilder.addEventListener('dragover', this.handleDragOver.bind(this));
        sandwichBuilder.addEventListener('drop', this.handleDrop.bind(this));
        
        if (typeof Sortable !== 'undefined') {
            new Sortable(sandwichBuilder, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: this.updateVisualPreview.bind(this)
            });
        }
    }
    
    setupCategoryTabs() {
        document.querySelectorAll('[data-category]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                this.filterByCategory(e.target.dataset.category);
                
                document.querySelectorAll('[data-category]').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
            });
        });
    }
    
    handleDragStart(e) {
        e.dataTransfer.setData('text/plain', e.target.dataset.ingredientId);
        e.dataTransfer.effectAllowed = 'copy';
    }
    
    handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    }
    
    handleDrop(e) {
        e.preventDefault();
        const ingredientId = e.dataTransfer.getData('text/plain');
        this.addIngredient(ingredientId);
    }
    
    addIngredient(ingredientId) {
        const ingredientElement = document.querySelector(`[data-ingredient-id="${ingredientId}"]`);
        if (!ingredientElement) return;
        
        const ingredient = {
            id: ingredientId,
            name: ingredientElement.dataset.ingredientName,
            price: parseFloat(ingredientElement.dataset.ingredientPrice),
            unit: ingredientElement.dataset.ingredientUnit,
            category: ingredientElement.dataset.ingredientCategory
        };
        
        if (this.selectedIngredients.has(ingredientId)) {
            this.showAlert('Ingrediente gi√† aggiunto alla ricetta', 'warning');
            return;
        }
        
        this.selectedIngredients.set(ingredientId, { 
            ...ingredient, 
            quantity: 1, 
            originalUnit: ingredient.unit,
            displayUnit: ingredient.unit 
        });
        this.renderSandwichLayer(ingredient);
        this.updateCostCalculation();
        this.updateFormInputs();
        this.updateVisualPreview();
        
        ingredientElement.classList.add('selected');
        this.showAlert(`${ingredient.name} aggiunto alla ricetta`, 'success', 2000);
    }
    
    removeIngredient(ingredientId) {
        if (this.selectedIngredients.has(ingredientId)) {
            const ingredient = this.selectedIngredients.get(ingredientId);
            this.selectedIngredients.delete(ingredientId);
            
            document.querySelector(`#layer-${ingredientId}`)?.remove();
            
            const ingredientElement = document.querySelector(`[data-ingredient-id="${ingredientId}"]`);
            ingredientElement?.classList.remove('selected');
            
            this.updateCostCalculation();
            this.updateFormInputs();
            this.updateVisualPreview();
            
            this.showAlert(`${ingredient.name} rimosso dalla ricetta`, 'info', 2000);
        }
    }
    
    renderSandwichLayer(ingredient, initialQuantity = 1) {
        const sandwichBuilder = document.getElementById('sandwich-builder');
        
        const layer = document.createElement('div');
        layer.className = `sandwich-layer ${ingredient.category.toLowerCase()}`;
        layer.id = `layer-${ingredient.id}`;
        layer.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="drag-handle me-2">
                        <i class="bi bi-grip-vertical"></i>
                    </div>
                    <div>
                        <div class="fw-medium">${ingredient.name}</div>
                        <small class="text-muted">‚Ç¨${ingredient.price.toFixed(7)} / ${ingredient.unit}</small>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <div class="quantity-control d-flex align-items-center gap-1">
                        <button type="button" class="btn btn-sm btn-outline-danger quantity-decrease" 
                                data-ingredient-id="${ingredient.id}">-</button>
                        <input type="number" class="form-control form-control-sm text-center quantity-input" 
                               value="${initialQuantity}" 
                               step="0.1" 
                               min="0.1"
                               style="width: 70px; -webkit-appearance: none; -moz-appearance: textfield;"
                               data-ingredient-id="${ingredient.id}">
                        <select class="form-select form-select-sm unit-selector" 
                                data-ingredient-id="${ingredient.id}"
                                data-current-unit="${ingredient.unit}"
                                style="width: 80px; font-size: 0.75rem;">
                            ${this.getUnitOptions(ingredient.unit)}
                        </select>
                        <button type="button" class="btn btn-sm btn-outline-success quantity-increase"
                                data-ingredient-id="${ingredient.id}">+</button>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger">√ó</button>
                </div>
            </div>
        `;
        
        sandwichBuilder.appendChild(layer);
        
        this.attachLayerEventListeners(layer, ingredient);
    }
    
    attachLayerEventListeners(layer, ingredient) {
        const quantityInput = layer.querySelector('.quantity-input');
        const decreaseBtn = layer.querySelector('.quantity-decrease');
        const increaseBtn = layer.querySelector('.quantity-increase');
        const removeBtn = layer.querySelector('.btn-danger');
        const unitSelector = layer.querySelector('.unit-selector');
        
        quantityInput.addEventListener('input', () => {
            const quantity = parseFloat(quantityInput.value) || 0;
            if (this.selectedIngredients.has(ingredient.id)) {
                this.selectedIngredients.get(ingredient.id).quantity = quantity;
                this.updateCostCalculation();
                this.updateFormInputs();
            }
        });
        
        decreaseBtn.addEventListener('click', () => {
            const currentValue = parseFloat(quantityInput.value) || 0;
            const newValue = Math.max(0.1, currentValue - 0.1);
            quantityInput.value = newValue.toFixed(1);
            if (this.selectedIngredients.has(ingredient.id)) {
                this.selectedIngredients.get(ingredient.id).quantity = newValue;
                this.updateCostCalculation();
                this.updateFormInputs();
            }
        });
        
        increaseBtn.addEventListener('click', () => {
            const currentValue = parseFloat(quantityInput.value) || 0;
            const newValue = currentValue + 0.1;
            quantityInput.value = newValue.toFixed(1);
            if (this.selectedIngredients.has(ingredient.id)) {
                this.selectedIngredients.get(ingredient.id).quantity = newValue;
                this.updateCostCalculation();
                this.updateFormInputs();
            }
        });
        
        removeBtn.addEventListener('click', () => {
            this.removeIngredient(ingredient.id);
        });
        
        unitSelector.addEventListener('change', () => {
            this.handleUnitConversion(ingredient.id, unitSelector.value);
        });
    }
    
    getUnitOptions(currentUnit) {
        const unitGroups = {
            weight: ['kg', 'hg', 'dag', 'g', 'dg'],
            volume: ['l', 'dl', 'cl', 'ml'],
            count: ['pieces', 'slices', 'portions']
        };
        
        let availableUnits = [];
        if (unitGroups.weight.includes(currentUnit)) {
            availableUnits = unitGroups.weight;
        } else if (unitGroups.volume.includes(currentUnit)) {
            availableUnits = unitGroups.volume;
        } else {
            availableUnits = unitGroups.count;
        }
        
        return availableUnits.map(unit => 
            `<option value="${unit}" ${unit === currentUnit ? 'selected' : ''}>${unit}</option>`
        ).join('');
    }
    
    handleUnitConversion(ingredientId, newUnit) {
        // Similar to create template but adapted for editing
        const layer = document.querySelector(`#layer-${ingredientId}`);
        const quantityInput = layer.querySelector('.quantity-input');
        const currentQuantity = parseFloat(quantityInput.value) || 0;
        const currentUnit = layer.querySelector('.unit-selector').getAttribute('data-current-unit') || 
                           this.selectedIngredients.get(ingredientId).unit;
        
        const convertedQuantity = this.convertQuantity(currentQuantity, currentUnit, newUnit);
        quantityInput.value = convertedQuantity;
        
        if (this.selectedIngredients.has(ingredientId)) {
            this.selectedIngredients.get(ingredientId).quantity = convertedQuantity;
            this.selectedIngredients.get(ingredientId).displayUnit = newUnit;
        }
        
        layer.querySelector('.unit-selector').setAttribute('data-current-unit', newUnit);
        
        this.updateCostCalculation();
        this.updateFormInputs();
    }
    
    convertQuantity(quantity, fromUnit, toUnit) {
        if (fromUnit === toUnit) return quantity;
        
        const weightToGrams = {
            'kg': 1000, 'hg': 100, 'dag': 10, 'g': 1, 'dg': 0.1
        };
        
        const volumeToMl = {
            'l': 1000, 'dl': 100, 'cl': 10, 'ml': 1
        };
        
        if (weightToGrams[fromUnit] && weightToGrams[toUnit]) {
            const grams = quantity * weightToGrams[fromUnit];
            return parseFloat((grams / weightToGrams[toUnit]).toFixed(3));
        }
        
        if (volumeToMl[fromUnit] && volumeToMl[toUnit]) {
            const ml = quantity * volumeToMl[fromUnit];
            return parseFloat((ml / volumeToMl[toUnit]).toFixed(3));
        }
        
        return quantity;
    }
    
    updateCostCalculation() {
        this.totalCost = 0;
        
        this.selectedIngredients.forEach(ingredient => {
            const originalQuantity = this.convertQuantity(
                ingredient.quantity, 
                ingredient.displayUnit || ingredient.unit, 
                ingredient.originalUnit || ingredient.unit
            );
            const cost = ingredient.price * originalQuantity;
            this.totalCost += cost;
        });
        
        document.getElementById('total-cost').textContent = `‚Ç¨${this.totalCost.toFixed(7)}`;
        document.getElementById('ingredient-count').textContent = this.selectedIngredients.size;
        
        this.calculateProfit();
    }
    
    calculateProfit() {
        const sellingPrice = parseFloat(document.getElementById('selling_price').value) || 0;
        const grossProfit = sellingPrice - this.totalCost;
        const profitPercentage = sellingPrice > 0 ? (grossProfit / sellingPrice * 100) : 0;
        
        const profitElement = document.getElementById('gross-profit');
        const percentageElement = document.getElementById('profit-percentage');
        
        profitElement.textContent = `‚Ç¨${grossProfit.toFixed(2)}`;
        profitElement.className = `profit-display ${grossProfit >= 0 ? 'text-white' : 'text-warning'}`;
        
        percentageElement.textContent = `${profitPercentage.toFixed(1)}%`;
        percentageElement.className = `profit-display ${profitPercentage >= 0 ? 'text-white' : 'text-warning'}`;
    }
    
    updateFormInputs() {
        const container = document.getElementById('ingredient-inputs');
        container.innerHTML = '';
        
        let index = 0;
        this.selectedIngredients.forEach((ingredient, id) => {
            const originalQuantity = this.convertQuantity(
                ingredient.quantity, 
                ingredient.displayUnit || ingredient.unit, 
                ingredient.originalUnit || ingredient.unit
            );
            
            container.innerHTML += `
                <input type="hidden" name="ingredient_ids[]" value="${id}">
                <input type="hidden" name="quantities[]" value="${originalQuantity}">
            `;
            index++;
        });
    }
    
    updateVisualPreview() {
        const preview = document.getElementById('sandwich-preview');
        const visual = preview.querySelector('.sandwich-visual');
        
        if (this.selectedIngredients.size === 0) {
            visual.innerHTML = `
                <div class="empty-sandwich py-5 text-center">
                    <i class="bi bi-burger display-4 text-muted"></i>
                    <p class="text-muted mt-2">Nessun ingrediente nella ricetta</p>
                </div>
            `;
            return;
        }
        
        let previewHTML = '<div class="sandwich-stack">';
        previewHTML += '<div class="layer-preview bun">üçû Bun Top</div>';
        
        const layers = Array.from(document.querySelectorAll('.sandwich-layer')).reverse();
        layers.forEach(layer => {
            const category = layer.className.match(/\b(base|protein|cheese|vegetable|sauce)\b/)?.[0] || 'other';
            const name = layer.querySelector('.fw-medium')?.textContent || '';
            const emoji = this.getCategoryEmoji(category);
            
            previewHTML += `<div class="layer-preview ${category}">${emoji} ${name}</div>`;
        });
        
        previewHTML += '<div class="layer-preview bun">üçû Bun Bottom</div>';
        previewHTML += '</div>';
        
        visual.innerHTML = previewHTML;
    }
    
    getCategoryEmoji(category) {
        const emojis = {
            'base': 'üçû', 'protein': 'ü•©', 'cheese': 'üßÄ', 
            'vegetable': 'ü•¨', 'sauce': 'üî¥', 'other': '‚ö™'
        };
        return emojis[category] || '‚ö™';
    }
    
    searchIngredients(e) {
        const searchTerm = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.ingredient-item');
        
        items.forEach(item => {
            const name = item.dataset.ingredientName.toLowerCase();
            const visible = name.includes(searchTerm);
            item.style.display = visible ? '' : 'none';
        });
        
        document.querySelectorAll('.ingredient-category').forEach(category => {
            const visibleItems = category.querySelectorAll('.ingredient-item:not([style*="display: none"])');
            category.style.display = visibleItems.length > 0 ? '' : 'none';
        });
    }
    
    filterByCategory(category) {
        const categories = document.querySelectorAll('.ingredient-category');
        
        categories.forEach(cat => {
            if (category === 'all' || cat.dataset.category === category) {
                cat.style.display = '';
            } else {
                cat.style.display = 'none';
            }
        });
    }
    
    validateAndSubmit(e) {
        if (this.selectedIngredients.size === 0) {
            e.preventDefault();
            this.showAlert('Aggiungi almeno un ingrediente alla ricetta', 'error');
            return false;
        }
        
        const hasBase = Array.from(this.selectedIngredients.values()).some(ing => 
            ing.category === 'BASE'
        );
        
        if (!hasBase) {
            e.preventDefault();
            this.showAlert('Aggiungi una base (panino) alla ricetta', 'warning');
            return false;
        }
        
        const requiredFields = {
            'name': 'Nome ricetta',
            'restaurant_id': 'ID Ristorante',
            'delivery_price_id': 'ID Prezzo Delivery',
            'selling_price': 'Prezzo di Vendita',
            'food_paper_cost_total': 'Food + Paper Cost Totale'
        };
        
        for (const [fieldId, fieldName] of Object.entries(requiredFields)) {
            const field = document.getElementById(fieldId);
            if (!field.value || field.value.trim() === '') {
                e.preventDefault();
                this.showAlert(`Il campo "${fieldName}" √® obbligatorio`, 'error');
                field.focus();
                return false;
            }
        }
        
        return true;
    }
    
    showAlert(message, type, duration = 3000) {
        const alertContainer = document.querySelector('.container-fluid');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        alertContainer.insertBefore(alert, alertContainer.firstChild);
        
        if (duration) {
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, duration);
        }
    }
    
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}

// Initialize editor
let sandwichEditor;
document.addEventListener('DOMContentLoaded', () => {
    sandwichEditor = new SandwichEditor();
});

// Global functions
function resetToOriginal() {
    if (confirm('Sei sicuro di voler ripristinare la ricetta originale? Tutte le modifiche andranno perse.')) {
        location.reload();
    }
}
</script>

<!-- Reuse CSS from create_sandwich.html -->
<style>
/* Copy the same styles from create_sandwich.html */
.sandwich-layer {
    margin: 0.5rem 0;
    padding: 1rem;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
    position: relative;
    cursor: move;
}

.sandwich-layer:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.sandwich-layer.base {
    background: linear-gradient(45deg, #deb887 0%, #d2b48c 100%);
    color: #5d4e37;
}

.sandwich-layer.protein {
    background: linear-gradient(45deg, #8b4513 0%, #a0522d 100%);
    color: white;
}

.sandwich-layer.cheese {
    background: linear-gradient(45deg, #ffd700 0%, #ffed4e 100%);
    color: #b8860b;
}

.sandwich-layer.vegetable {
    background: linear-gradient(45deg, #90ee90 0%, #98fb98 100%);
    color: #228b22;
}

.sandwich-layer.sauce {
    background: linear-gradient(45deg, #ff6b6b 0%, #ee5a52 100%);
    color: white;
}

.layer-preview {
    padding: 0.5rem;
    margin: 0.25rem 0;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 0.25rem;
    text-align: center;
    font-size: 0.9rem;
    border: 1px solid #dee2e6;
}

.ingredient-item {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.ingredient-item:hover {
    border-color: var(--bs-primary);
    transform: translateX(5px);
}

.ingredient-item.selected {
    border-color: var(--bs-primary);
    background-color: rgba(13, 110, 253, 0.05);
}

.nav-pills .nav-link {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
}

.quantity-input {
    text-align: center;
}

.unit-selector {
    border-left: none !important;
    border-radius: 0 !important;
    background-color: #FFC72C;
    color: #27251F;
    font-weight: 600;
    text-align: center;
}

.unit-selector:focus {
    border-color: var(--bs-primary);
    box-shadow: none;
}

@media (max-width: 768px) {
    .sandwich-layer {
        padding: 0.75rem;
    }
    
    .quantity-input {
        width: 60px !important;
    }
    
    .nav-pills .nav-link {
        font-size: 0.75rem;
        padding: 0.375rem 0.5rem;
    }
}
</style>
{% endblock %}