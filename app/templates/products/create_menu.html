{% extends "base.html" %}

{% block title %}Crea Menu{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12 mb-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('main.products') }}">Prodotti</a></li>
                    <li class="breadcrumb-item active">Crea Nuovo Menu</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">
                <i class="bi bi-plus-circle me-2 text-primary"></i>
                Crea Nuovo Menu
            </h1>
        </div>
    </div>

    <div class="row justify-content-center">
        <!-- Form Column -->
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear me-2"></i>Dettagli Menu
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" novalidate>
                        <div class="mb-3">
                            <label for="name" class="form-label">Nome Menu *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   placeholder="Es: Big Burger Menu Classic" required maxlength="100">
                            <div class="invalid-feedback">
                                Inserisci un nome per il menu.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="product_code" class="form-label">Codice Menu</label>
                            <input type="text" class="form-control" id="product_code" name="product_code" 
                                   placeholder="Es: MN001" maxlength="20">
                            <div class="form-text">Codice univoco per identificare il menu (opzionale)</div>
                        </div>

                        <div class="mb-3">
                            <label for="base_product_search" class="form-label">Prodotto Base *</label>
                            <div class="position-relative">
                                <input type="text" 
                                       class="form-control" 
                                       id="base_product_search" 
                                       placeholder="Inizia a scrivere per cercare un prodotto..."
                                       autocomplete="off"
                                       required>
                                <div class="dropdown-menu w-100" id="product_dropdown" style="max-height: 250px; overflow-y: auto;">
                                    {% for product in sandwiches %}
                                    <div class="dropdown-item product-option" 
                                         data-product-id="{{ product.id }}"
                                         data-product-name="{{ product.name }}"
                                         data-cost="{{ product.food_paper_cost_total or 0 }}"
                                         data-search-text="{{ product.name.lower() }}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="fw-medium">{{ product.name }}</div>
                                                <small class="text-muted">{{ product.product_type.title() }}</small>
                                            </div>
                                            <span class="badge bg-success">€{{ "%.3f"|format(product.food_paper_cost_total or 0) }}</span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% if not sandwiches %}
                                    <div class="dropdown-item-text text-center text-muted py-3">
                                        <i class="bi bi-inbox display-6"></i><br>
                                        Nessun prodotto disponibile<br>
                                        <a href="{{ url_for('main.create_sandwich') }}" class="btn btn-sm btn-primary mt-2">
                                            <i class="bi bi-plus me-1"></i>Crea Prodotto
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                                <input type="hidden" id="base_product_id" name="base_product_id" required>
                            </div>
                            <div class="form-text">
                                Inizia a scrivere il nome del prodotto per filtrare la lista
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fries_size" class="form-label">
                                        <i class="bi bi-plus-circle me-1"></i>Patatine
                                    </label>
                                    <select class="form-select" id="fries_size" name="fries_size">
                                        <option value="">Nessuna</option>
                                        <option value="small">Small</option>
                                        <option value="medium">Medium</option>
                                        <option value="large">Large</option>
                                    </select>
                                    <div class="mt-2" id="fries_cost_container" style="display: none;">
                                        <label for="fries_fp_cost" class="form-label">Costo F&P Patatine (€) *</label>
                                        <input type="number" class="form-control" id="fries_fp_cost" name="fries_fp_cost" 
                                               step="0.001" min="0" placeholder="0.000">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="drink_size" class="form-label">
                                        <i class="bi bi-cup-straw me-1"></i>Bibita
                                    </label>
                                    <select class="form-select" id="drink_size" name="drink_size">
                                        <option value="">Nessuna</option>
                                        <option value="small">Small</option>
                                        <option value="medium">Medium</option>
                                        <option value="large">Large</option>
                                    </select>
                                    <div class="mt-2" id="drink_cost_container" style="display: none;">
                                        <label for="drink_fp_cost" class="form-label">Costo F&P Bibita (€) *</label>
                                        <input type="number" class="form-control" id="drink_fp_cost" name="drink_fp_cost" 
                                               step="0.001" min="0" placeholder="0.000">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="mb-3">
                                <i class="bi bi-calculator me-2"></i>Costo Totale Menu
                            </h6>
                            <div class="p-3 bg-light rounded">
                                <div class="row text-center">
                                    <div class="col-md-4">
                                        <div class="mb-2">
                                            <small class="text-muted">Prodotto Base</small>
                                            <div class="h5 text-primary" id="base-cost">€0.000</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-2">
                                            <small class="text-muted">Patatine</small>
                                            <div class="h5 text-warning" id="fries-cost-display">€0.000</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-2">
                                            <small class="text-muted">Bibita</small>
                                            <div class="h5 text-info" id="drink-cost-display">€0.000</div>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <small class="text-muted">Costo F&P Totale</small>
                                    <div class="h3 text-success" id="total-cost">€0.000</div>
                                </div>
                            </div>
                            <input type="hidden" id="food_paper_cost_total" name="food_paper_cost_total" value="0">
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-2"></i>Crea Menu
                            </button>
                            <a href="{{ url_for('main.products') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-lg me-2"></i>Annulla
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const searchInput = document.getElementById('base_product_search');
    const dropdown = document.getElementById('product_dropdown');
    const hiddenInput = document.getElementById('base_product_id');
    const productOptions = document.querySelectorAll('.product-option');
    const friesSizeSelect = document.getElementById('fries_size');
    const drinkSizeSelect = document.getElementById('drink_size');
    const friesCostContainer = document.getElementById('fries_cost_container');
    const drinkCostContainer = document.getElementById('drink_cost_container');
    const friesCostInput = document.getElementById('fries_fp_cost');
    const drinkCostInput = document.getElementById('drink_fp_cost');
    
    // Display elements
    const baseCostDisplay = document.getElementById('base-cost');
    const friesCostDisplay = document.getElementById('fries-cost-display');
    const drinkCostDisplay = document.getElementById('drink-cost-display');
    const totalCostDisplay = document.getElementById('total-cost');
    const hiddenTotalInput = document.getElementById('food_paper_cost_total');
    
    let selectedProduct = null;
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        let hasVisibleOptions = false;
        
        productOptions.forEach(option => {
            const searchText = option.dataset.searchText;
            if (searchText.includes(searchTerm)) {
                option.style.display = 'block';
                hasVisibleOptions = true;
            } else {
                option.style.display = 'none';
            }
        });
        
        // Show/hide dropdown
        if (searchTerm.length > 0 && hasVisibleOptions) {
            dropdown.classList.add('show');
        } else {
            dropdown.classList.remove('show');
        }
        
        // Clear selection if search doesn't match current selection
        if (selectedProduct && !selectedProduct.dataset.searchText.includes(searchTerm)) {
            clearSelection();
        }
    });
    
    // Focus/blur events
    searchInput.addEventListener('focus', function() {
        if (this.value.length > 0) {
            dropdown.classList.add('show');
        }
    });
    
    searchInput.addEventListener('blur', function() {
        // Delay to allow click on dropdown items
        setTimeout(() => {
            dropdown.classList.remove('show');
        }, 200);
    });
    
    // Product selection
    productOptions.forEach(option => {
        option.addEventListener('click', function() {
            selectedProduct = this;
            const productName = this.dataset.productName;
            const productId = this.dataset.productId;
            
            searchInput.value = productName;
            hiddenInput.value = productId;
            dropdown.classList.remove('show');
            
            updateTotalCost();
        });
    });
    
    function clearSelection() {
        selectedProduct = null;
        hiddenInput.value = '';
        updateTotalCost();
    }
    
    // Show/hide cost inputs based on selection
    friesSizeSelect.addEventListener('change', function() {
        if (this.value) {
            friesCostContainer.style.display = 'block';
            friesCostInput.required = true;
        } else {
            friesCostContainer.style.display = 'none';
            friesCostInput.required = false;
            friesCostInput.value = '';
            updateTotalCost();
        }
    });
    
    drinkSizeSelect.addEventListener('change', function() {
        if (this.value) {
            drinkCostContainer.style.display = 'block';
            drinkCostInput.required = true;
        } else {
            drinkCostContainer.style.display = 'none';
            drinkCostInput.required = false;
            drinkCostInput.value = '';
            updateTotalCost();
        }
    });
    
    // Update costs when values change
    friesCostInput.addEventListener('input', updateTotalCost);
    drinkCostInput.addEventListener('input', updateTotalCost);
    
    function updateTotalCost() {
        let baseCost = 0;
        let friesCost = 0;
        let drinkCost = 0;
        
        // Base product cost
        if (selectedProduct && hiddenInput.value) {
            baseCost = parseFloat(selectedProduct.dataset.cost) || 0;
        }
        
        // Fries cost
        if (friesSizeSelect.value && friesCostInput.value) {
            friesCost = parseFloat(friesCostInput.value) || 0;
        }
        
        // Drink cost
        if (drinkSizeSelect.value && drinkCostInput.value) {
            drinkCost = parseFloat(drinkCostInput.value) || 0;
        }
        
        const totalCost = baseCost + friesCost + drinkCost;
        
        // Update displays
        baseCostDisplay.textContent = `€${baseCost.toFixed(3)}`;
        friesCostDisplay.textContent = `€${friesCost.toFixed(3)}`;
        drinkCostDisplay.textContent = `€${drinkCost.toFixed(3)}`;
        totalCostDisplay.textContent = `€${totalCost.toFixed(3)}`;
        hiddenTotalInput.value = totalCost.toFixed(3);
    }
    
    // Initialize
    updateTotalCost();
});
</script>

<style>
.product-option {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.product-option:hover {
    background-color: var(--bs-primary);
    color: white;
}

.product-option:hover .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

.product-option:hover .badge {
    background-color: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}

#product_dropdown {
    z-index: 1050;
    border: 1px solid var(--bs-border-color);
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
}

#product_dropdown.show {
    display: block !important;
}

.position-relative #base_product_search:focus {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}

.position-relative #product_dropdown.show + input:focus {
    box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
}
</style>
{% endblock %}