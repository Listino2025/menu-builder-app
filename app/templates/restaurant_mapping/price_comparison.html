{% extends "base.html" %}

{% block title %}Confronto Prezzi - Menu Builder{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-graph-up me-2 text-primary"></i>Confronto Prezzi
                    </h1>
                    <p class="text-muted mb-0">Analizza e confronta i prezzi dei prodotti tra i ristoranti</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('restaurant_mapping.index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Torna alla Mappa
                    </a>
                    <button class="btn btn-outline-primary" onclick="exportComparison()">
                        <i class="bi bi-download me-1"></i>Esporta CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="product-filter" class="form-label">Filtra per Prodotto</label>
                            <input type="text" class="form-control" id="product-filter" 
                                   placeholder="Cerca prodotti...">
                        </div>
                        <div class="col-md-3">
                            <label for="restaurant-filter" class="form-label">Ristoranti</label>
                            <select class="form-select" id="restaurant-filter" multiple>
                                {% for restaurant in restaurants %}
                                <option value="{{ restaurant.id }}">{{ restaurant.name }} - {{ restaurant.city }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Ctrl+click per selezione multipla</small>
                        </div>
                        <div class="col-md-2">
                            <label for="category-filter" class="form-label">Categoria</label>
                            <select class="form-select" id="category-filter">
                                <option value="">Tutte</option>
                                <option value="product">Prodotti</option>
                                <option value="menu">Menu</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="sort-filter" class="form-label">Ordina per</label>
                            <select class="form-select" id="sort-filter">
                                <option value="name">Nome Prodotto</option>
                                <option value="min_price">Prezzo Minimo</option>
                                <option value="max_price">Prezzo Massimo</option>
                                <option value="price_range">Variazione Prezzo</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="bi bi-funnel me-1"></i>Applica
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grouped Bar Chart Section -->
    {% if comparison_data %}
    <div class="card mb-4" id="charts-section" style="display: none;">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bar-chart me-2"></i>Analisi Profitti per Prodotto e Ristorante
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleCharts()">
                    <i class="bi bi-eye" id="charts-toggle-icon"></i>
                    <span id="charts-toggle-text">Mostra Grafici</span>
                </button>
            </div>
        </div>
        <div class="card-body">
            
            <!-- Chart Controls -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Scenario di Profitto:</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="profit-type" id="profit-onsite" value="onsite" checked>
                        <label class="btn btn-outline-primary" for="profit-onsite">
                            <i class="bi bi-shop me-1"></i>On Site
                        </label>
                        <input type="radio" class="btn-check" name="profit-type" id="profit-delivery" value="delivery">
                        <label class="btn btn-outline-info" for="profit-delivery">
                            <i class="bi bi-truck me-1"></i>Delivery
                        </label>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label fw-bold">Selezione Ristoranti:</label>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="selectAllRestaurantsForChart()">
                            <i class="bi bi-check-all me-1"></i>Tutti
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearAllRestaurantsForChart()">
                            <i class="bi bi-x-circle me-1"></i>Nessuno
                        </button>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label fw-bold">Ordinamento:</label>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortChartByProfit()">
                            <i class="bi bi-sort-numeric-down me-1"></i>Per Profitto
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortChartByName()">
                            <i class="bi bi-sort-alpha-down me-1"></i>Per Nome
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Restaurant Selection -->
            <div class="row mb-3">
                <div class="col-12">
                    <label class="form-label fw-bold">Ristoranti da Visualizzare:</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% set processed_restaurants = [] %}
                        {% for item in comparison_data %}
                            {% for listing in item.listings %}
                                {% if listing.restaurant_id not in processed_restaurants %}
                                    {% set _ = processed_restaurants.append(listing.restaurant_id) %}
                                    <div class="form-check">
                                        <input class="form-check-input restaurant-chart-filter" 
                                               type="checkbox" 
                                               value="{{ listing.restaurant_id }}" 
                                               id="chart-restaurant-{{ listing.restaurant_id }}" 
                                               checked>
                                        <label class="form-check-label" for="chart-restaurant-{{ listing.restaurant_id }}">
                                            <small>{{ listing.restaurant_name }}</small>
                                        </label>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Chart Canvas -->
            <div class="row">
                <div class="col-12">
                    <div class="chart-container" style="position: relative; height: 400px; margin-top: 20px;">
                        <canvas id="profit-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Chart Actions -->
            <div class="row mt-3">
                <div class="col-12 text-end">
                    <button class="btn btn-sm btn-outline-info" onclick="exportChartData()">
                        <i class="bi bi-download me-1"></i>Esporta Dati Grafico
                    </button>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Comparison Results -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-table me-2"></i>Confronto Prezzi ({{ comparison_data|length }} prodotti)
                        </h5>
                        <button class="btn btn-primary btn-sm" onclick="toggleCharts()">
                            <i class="bi bi-bar-chart me-1"></i>
                            <span id="main-charts-toggle-text">Mostra Grafici Interattivi</span>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0" id="comparison-table">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 25%">
                                        <i class="bi bi-box-seam me-2"></i>Prodotto
                                    </th>
                                    <th style="width: 12%">
                                        <i class="bi bi-tags me-2"></i>Categoria
                                    </th>
                                    <th style="width: 10%">
                                        <i class="bi bi-cash-stack me-2"></i>F&P Cost
                                    </th>
                                    <th style="width: 30%">
                                        <i class="bi bi-currency-euro me-2"></i>Prezzi per Ristorante
                                    </th>
                                    <th style="width: 23%">
                                        <i class="bi bi-graph-up me-2"></i>Gross Profit
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in comparison_data %}
                                <tr class="comparison-row" 
                                    data-product-name="{{ item.product.name.lower() }}"
                                    data-product-category="{{ item.product.product_type.lower() }}"
                                    data-min-price="{{ item.min_price }}"
                                    data-max-price="{{ item.max_price }}"
                                    data-price-range="{{ item.price_range }}"
                                    data-restaurants="{{ item.listings|map(attribute='restaurant_id')|join(',') }}">
                                    <td>
                                        <div>
                                            <strong>{{ item.product.name }}</strong>
                                            <br><small class="text-muted">#{{ item.product.id }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {{ item.product.product_type.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong class="text-danger">€{{ "%.3f"|format(item.product.food_paper_cost_total or 0) }}</strong>
                                        {% if item.product.product_type == 'menu' and item.product.base_product %}
                                            <br><small class="text-muted">
                                                Base: €{{ "%.3f"|format(item.product.base_product.food_paper_cost_total or 0) }}
                                                {% if item.product.fries_fp_cost %} + Patatine: €{{ "%.3f"|format(item.product.fries_fp_cost) }}{% endif %}
                                                {% if item.product.drink_fp_cost %} + Bibita: €{{ "%.3f"|format(item.product.drink_fp_cost) }}{% endif %}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="restaurant-prices">
                                            {% for listing in item.listings %}
                                            <div class="price-item mb-2 p-2 bg-light rounded">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>{{ listing.restaurant_name }}</strong>
                                                        <br><small class="text-muted">{{ listing.city }}</small>
                                                        {% if not listing.is_available %}
                                                        <br><span class="badge bg-warning text-dark">Non Disponibile</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="fw-bold text-primary">€{{ "%.2f"|format(listing.local_price) }}</div>
                                                        <small class="text-muted">On Site</small>
                                                        <br>
                                                        <div class="fw-bold text-info">€{{ "%.2f"|format(listing.delivery_price) }}</div>
                                                        <small class="text-muted">Delivery</small>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="restaurant-profits">
                                            {% for listing in item.listings %}
                                            <div class="profit-item mb-2 p-2 bg-light rounded">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="text-center">
                                                            <div class="fw-bold {{ 'text-success' if listing.local_profit >= 0 else 'text-danger' }}">
                                                                €{{ "%.2f"|format(listing.local_profit) }}
                                                            </div>
                                                            <small class="text-muted">On Site</small>
                                                            <br><small class="{{ 'text-success' if listing.local_profit >= 0 else 'text-danger' }}">
                                                                {{ "%.1f"|format(listing.local_margin) }}%
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center">
                                                            <div class="fw-bold {{ 'text-success' if listing.delivery_profit >= 0 else 'text-danger' }}">
                                                                €{{ "%.2f"|format(listing.delivery_profit) }}
                                                            </div>
                                                            <small class="text-muted">Delivery</small>
                                                            <br><small class="{{ 'text-success' if listing.delivery_profit >= 0 else 'text-danger' }}">
                                                                {{ "%.1f"|format(listing.delivery_margin) }}%
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-graph-up display-1 text-muted opacity-50"></i>
                    <h3 class="mt-3">Nessun Dato di Confronto</h3>
                    <p class="text-muted">
                        Non ci sono prodotti con listini configurati per il confronto prezzi.
                    </p>
                    <div class="mt-3">
                        <a href="{{ url_for('restaurant_mapping.restaurants') }}" class="btn btn-primary">
                            <i class="bi bi-building me-2"></i>Gestisci Ristoranti
                        </a>
                        <a href="{{ url_for('main.create_sandwich') }}" class="btn btn-outline-primary ms-2">
                            <i class="bi bi-plus-circle me-2"></i>Crea Prodotti
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.comparison-row:hover {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.profit-positive {
    background: linear-gradient(90deg, rgba(25, 135, 84, 0.1) 0%, transparent 100%);
}

.profit-negative {
    background: linear-gradient(90deg, rgba(220, 53, 69, 0.1) 0%, transparent 100%);
}

.restaurant-prices .price-item {
    border-left: 3px solid #007bff;
    transition: all 0.3s ease;
}

.restaurant-prices .price-item:hover {
    border-left-color: #0056b3;
    transform: translateX(2px);
}

.profit-item {
    transition: all 0.2s ease;
    border-radius: 8px !important;
}

.profit-item:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#comparison-table th {
    position: sticky;
    top: 0;
    z-index: 10;
}

.table-dark th {
    background-color: #212529 !important;
    color: #fff !important;
    font-weight: 600;
    letter-spacing: 0.5px;
}
</style>

<script>
// ===== ESSENTIAL FUNCTIONS FIRST =====

// Charts visibility state
let chartsVisible = false;
let groupedProfitChart = null;
let profitChart = null; // Prevent old system from initializing

// CRITICAL: Define toggleCharts at the very beginning
function toggleCharts() {
    const chartsSection = document.getElementById('charts-section');
    const toggleIcon = document.getElementById('charts-toggle-icon');
    const toggleText = document.getElementById('charts-toggle-text');
    const mainToggleText = document.getElementById('main-charts-toggle-text');
    
    if (chartsVisible) {
        chartsSection.style.display = 'none';
        if (toggleIcon) toggleIcon.className = 'bi bi-eye';
        if (toggleText) toggleText.textContent = 'Mostra Grafici';
        if (mainToggleText) mainToggleText.textContent = 'Mostra Grafici Interattivi';
        chartsVisible = false;
    } else {
        chartsSection.style.display = 'block';
        if (toggleIcon) toggleIcon.className = 'bi bi-eye-slash';
        if (toggleText) toggleText.textContent = 'Nascondi Grafici';
        if (mainToggleText) mainToggleText.textContent = 'Nascondi Grafici Interattivi';
        chartsVisible = true;
        
        // Scroll to charts section
        chartsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Initialize chart if not already done
        if (!groupedProfitChart) {
            setTimeout(() => {
                initializeGroupedBarChart();
                toggleChartScenario();
            }, 100);
        }
    }
}


// Extract data from template for charts
const comparisonData = [
    {% for item in comparison_data %}
    {
        productName: "{{ item.product.name|e }}",
        productType: "{{ item.product.product_type }}",
        fpCost: {{ item.product.food_paper_cost_total or 0 }},
        listings: [
            {% for listing in item.listings %}
            {
                restaurantId: {{ listing.restaurant_id }},
                restaurantName: "{{ listing.restaurant_name|e }}",
                localPrice: {{ listing.local_price }},
                deliveryPrice: {{ listing.delivery_price }},
                localProfit: {{ listing.local_profit }},
                deliveryProfit: {{ listing.delivery_profit }},
                localMargin: {{ listing.local_margin }},
                deliveryMargin: {{ listing.delivery_margin }},
                isAvailable: {{ 'true' if listing.is_available else 'false' }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Old toggleCharts removed - using new grouped bar chart system

// Old updateChart function removed - using new grouped bar chart system

// Old restaurant selection functions removed - using new grouped bar chart system

// Table filtering function
function filterTable() {
    const productFilter = document.getElementById('product-filter').value.toLowerCase();
    const restaurantFilter = Array.from(document.getElementById('restaurant-filter').selectedOptions).map(opt => opt.value);
    const categoryFilter = document.getElementById('category-filter').value.toLowerCase();
    
    document.querySelectorAll('.comparison-row').forEach(row => {
        const productName = row.dataset.productName || '';
        const productCategory = row.dataset.productCategory || '';
        
        const nameMatch = !productFilter || productName.includes(productFilter);
        const categoryMatch = !categoryFilter || productCategory.includes(categoryFilter);
        const restaurantMatch = restaurantFilter.length === 0;
        
        if (nameMatch && categoryMatch && restaurantMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Old chart system removed
    setupEventListeners();
    applyRowStyles()
});

// Old initializeChart function removed - using new grouped bar chart system

// Setup event listeners
function setupEventListeners() {
    // Old chart event listeners removed - using new grouped bar chart system
    
    // Table filters only
    document.getElementById('product-filter').addEventListener('input', filterTable);
    document.getElementById('restaurant-filter').addEventListener('change', filterTable);
    document.getElementById('category-filter').addEventListener('change', filterTable);
    document.getElementById('sort-filter').addEventListener('change', filterTable);
}

// Apply visual enhancements to table rows
function applyRowStyles() {
    const rows = document.querySelectorAll('.comparison-row');
    rows.forEach(row => {
        // Apply profit-based styling
        const profitItems = row.querySelectorAll('.profit-item');
        profitItems.forEach(item => {
            const profitValue = parseFloat(item.querySelector('.fw-bold').textContent.replace(/[€,]/g, ''));
            if (profitValue > 0) {
                item.classList.add('profit-positive');
            } else if (profitValue < 0) {
                item.classList.add('profit-negative');
            }
        });
    });
}

function applyFilters() {
    // This function now just calls filterTable for consistency
    filterTable();
}

function calculateSummaryStats(data) {
    // Old summary stats system removed - using new grouped bar chart system
    return;
}

function exportComparison() {
    // Generate CSV content
    let csv = 'Prodotto,Categoria,Ristorante,Città,Prezzo Locale,Prezzo Delivery,Markup,Disponibile\\n';
    
    const rows = document.querySelectorAll('.comparison-row:not([style*="display: none"])');
    rows.forEach(row => {
        const productName = row.querySelector('strong').textContent;
        const category = row.querySelector('.badge').textContent;
        
        const priceItems = row.querySelectorAll('.price-item');
        priceItems.forEach(item => {
            const restaurantName = item.querySelector('strong').textContent;
            const city = item.querySelector('.text-muted').textContent.replace(/[()]/g, '');
            const isAvailable = !item.querySelector('.badge.bg-warning');
            
            const prices = item.querySelectorAll('.fw-bold');
            const localPrice = prices[0].textContent.replace('€', '');
            const deliveryPrice = prices[1].textContent.replace('€', '');
            const markup = (parseFloat(deliveryPrice) - parseFloat(localPrice)).toFixed(2);
            
            csv += `"${productName}","${category}","${restaurantName}","${city}",${localPrice},${deliveryPrice},${markup},"${isAvailable ? 'Sì' : 'No'}"\\n`;
        });
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `confronto_prezzi_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Old chart system removed - only grouped bar chart system is used

// ===== GROUPED BAR CHART SYSTEM =====

// Color palette for restaurants
const restaurantColors = [
    { bg: 'rgba(255, 99, 132, 0.8)', border: 'rgb(255, 99, 132)' },
    { bg: 'rgba(54, 162, 235, 0.8)', border: 'rgb(54, 162, 235)' },
    { bg: 'rgba(255, 205, 86, 0.8)', border: 'rgb(255, 205, 86)' },
    { bg: 'rgba(75, 192, 192, 0.8)', border: 'rgb(75, 192, 192)' },
    { bg: 'rgba(153, 102, 255, 0.8)', border: 'rgb(153, 102, 255)' },
    { bg: 'rgba(255, 159, 64, 0.8)', border: 'rgb(255, 159, 64)' },
    { bg: 'rgba(199, 199, 199, 0.8)', border: 'rgb(199, 199, 199)' },
    { bg: 'rgba(83, 102, 255, 0.8)', border: 'rgb(83, 102, 255)' }
];

function initializeGroupedBarChart() {
    if (groupedProfitChart) {
        groupedProfitChart.destroy();
    }
    
    const ctx = document.getElementById('profit-chart').getContext('2d');
    
    groupedProfitChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Confronto Gross Profit per Prodotto e Ristorante',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Prodotto: ' + context[0].label;
                        },
                        label: function(context) {
                            const restaurantName = context.dataset.label;
                            const profit = context.parsed.y;
                            const scenario = document.querySelector('input[name="profit-type"]:checked')?.value === 'delivery' ? 'Delivery' : 'On Site';
                            const profitColor = profit >= 0 ? '🟢' : '🔴';
                            return `${profitColor} ${restaurantName} (${scenario}): €${profit.toFixed(2)}`;
                        },
                        footer: function(context) {
                            if (context.length > 1) {
                                const profits = context.map(item => item.parsed.y);
                                const avgProfit = profits.reduce((sum, p) => sum + p, 0) / profits.length;
                                return `Media prodotto: €${avgProfit.toFixed(2)}`;
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Gross Profit (€)',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        callback: function(value) {
                            return '€' + value.toFixed(2);
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Prodotti',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0,
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function updateGroupedBarChart(isDelivery = false) {
    if (!groupedProfitChart) return;
    
    const selectedRestaurants = Array.from(document.querySelectorAll('.restaurant-chart-filter:checked'))
        .map(cb => parseInt(cb.value));
    
    if (selectedRestaurants.length === 0) {
        groupedProfitChart.data.labels = [];
        groupedProfitChart.data.datasets = [];
        groupedProfitChart.update();
        return;
    }
    
    const productData = {};
    const restaurantNames = {};
    
    comparisonData.forEach(item => {
        const filteredListings = item.listings.filter(listing => 
            selectedRestaurants.includes(listing.restaurantId) && listing.isAvailable
        );
        
        if (filteredListings.length > 0) {
            productData[item.productName] = {};
            
            filteredListings.forEach(listing => {
                const profit = isDelivery ? listing.deliveryProfit : listing.localProfit;
                productData[item.productName][listing.restaurantId] = profit;
                restaurantNames[listing.restaurantId] = listing.restaurantName;
            });
        }
    });
    
    const datasets = [];
    const productNames = Object.keys(productData);
    
    selectedRestaurants.forEach((restaurantId, index) => {
        const restaurantName = restaurantNames[restaurantId];
        if (!restaurantName) return;
        
        const data = productNames.map(productName => {
            return productData[productName][restaurantId] || 0;
        });
        
        const colorIndex = index % restaurantColors.length;
        
        datasets.push({
            label: restaurantName,
            data: data,
            backgroundColor: restaurantColors[colorIndex].bg,
            borderColor: restaurantColors[colorIndex].border,
            borderWidth: 1,
            borderRadius: 2,
            maxBarThickness: 40
        });
    });
    
    groupedProfitChart.data.labels = productNames;
    groupedProfitChart.data.datasets = datasets;
    
    const scenario = isDelivery ? 'Delivery' : 'On Site';
    groupedProfitChart.options.plugins.title.text = `Confronto Gross Profit ${scenario} per Prodotto e Ristorante`;
    
    groupedProfitChart.update();
}

function toggleChartScenario() {
    const isDelivery = document.querySelector('input[name="profit-type"]:checked')?.value === 'delivery';
    updateGroupedBarChart(isDelivery);
}

function selectAllRestaurantsForChart() {
    document.querySelectorAll('.restaurant-chart-filter').forEach(cb => {
        cb.checked = true;
    });
    toggleChartScenario();
}

function clearAllRestaurantsForChart() {
    document.querySelectorAll('.restaurant-chart-filter').forEach(cb => {
        cb.checked = false;
    });
    toggleChartScenario();
}

function sortChartByProfit() {
    if (!groupedProfitChart || !groupedProfitChart.data.labels.length) return;
    
    const productProfits = groupedProfitChart.data.labels.map((label, index) => {
        const profits = groupedProfitChart.data.datasets.map(dataset => dataset.data[index] || 0);
        const avgProfit = profits.reduce((sum, p) => sum + p, 0) / profits.length;
        return { label, avgProfit, index };
    });
    
    productProfits.sort((a, b) => b.avgProfit - a.avgProfit);
    
    const newLabels = productProfits.map(p => p.label);
    const newDatasets = groupedProfitChart.data.datasets.map(dataset => ({
        ...dataset,
        data: productProfits.map(p => dataset.data[p.index])
    }));
    
    groupedProfitChart.data.labels = newLabels;
    groupedProfitChart.data.datasets = newDatasets;
    groupedProfitChart.update();
}

function sortChartByName() {
    if (!groupedProfitChart || !groupedProfitChart.data.labels.length) return;
    
    const sortedIndices = groupedProfitChart.data.labels
        .map((label, index) => ({ label, index }))
        .sort((a, b) => a.label.localeCompare(b.label))
        .map(item => item.index);
    
    const newLabels = sortedIndices.map(i => groupedProfitChart.data.labels[i]);
    const newDatasets = groupedProfitChart.data.datasets.map(dataset => ({
        ...dataset,
        data: sortedIndices.map(i => dataset.data[i])
    }));
    
    groupedProfitChart.data.labels = newLabels;
    groupedProfitChart.data.datasets = newDatasets;
    groupedProfitChart.update();
}

function exportChartData() {
    if (!groupedProfitChart || !groupedProfitChart.data.labels.length) {
        alert('Nessun dato da esportare nel grafico');
        return;
    }
    
    const scenario = document.querySelector('input[name="profit-type"]:checked')?.value === 'delivery' ? 'Delivery' : 'OnSite';
    
    let csv = `Prodotto,${groupedProfitChart.data.datasets.map(d => d.label).join(',')}\n`;
    
    groupedProfitChart.data.labels.forEach((product, productIndex) => {
        const row = [product];
        groupedProfitChart.data.datasets.forEach(dataset => {
            row.push((dataset.data[productIndex] || 0).toFixed(2));
        });
        csv += row.join(',') + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `gross_profit_${scenario}_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Add the missing event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name="profit-type"]').forEach(radio => {
        radio.addEventListener('change', toggleChartScenario);
    });
    
    document.querySelectorAll('.restaurant-chart-filter').forEach(cb => {
        cb.addEventListener('change', toggleChartScenario);
    });
});

</script>

{% endblock %}