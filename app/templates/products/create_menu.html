{% extends "base.html" %}

{% block title %}Crea Menu - Menu Builder{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Header -->
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-journal-text me-2 text-primary"></i>Crea Nuovo Menu
                    </h1>
                    <p class="text-muted mb-0">Componi un menu personalizzato con i tuoi prodotti</p>
                </div>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Torna alla Dashboard
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Menu Builder -->
        <div class="col-12 col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-plus-circle me-2"></i>Costruttore Menu
                    </h5>
                </div>
                <div class="card-body">
                    <form id="menuForm" method="POST" class="needs-validation" novalidate>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="menu_name" class="form-label">Nome Menu *</label>
                                <input type="text" class="form-control" id="menu_name" name="name" required>
                                <div class="invalid-feedback">
                                    Inserisci il nome del menu.
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="product_code_id" class="form-label">ID Codice Prodotto *</label>
                                <input type="text" class="form-control" id="product_code_id" name="product_code_id" 
                                       placeholder="es. MN_001_CLASSIC" required>
                                <div class="invalid-feedback">
                                    Inserisci l'ID del codice prodotto.
                                </div>
                                <small class="text-muted">Identificativo univoco del menu nel sistema McDonald's</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="restaurant_id" class="form-label">ID Ristorante *</label>
                                <select class="form-select" id="restaurant_id" name="restaurant_id" required>
                                    <option value="">Seleziona ristorante...</option>
                                    <option value="REST_001">McDonald's Roma Centro</option>
                                    <option value="REST_002">McDonald's Milano Duomo</option>
                                    <option value="REST_003">McDonald's Napoli Centrale</option>
                                    <option value="REST_004">McDonald's Torino Porta Nuova</option>
                                    <option value="REST_005">McDonald's Firenze Santa Maria Novella</option>
                                </select>
                                <div class="invalid-feedback">
                                    Seleziona un ristorante per i prezzi specifici.
                                </div>
                                <small class="text-muted">Per prezzi specifici per site</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="delivery_price_id" class="form-label">ID Prezzo Delivery *</label>
                                <input type="text" class="form-control" id="delivery_price_id" name="delivery_price_id" 
                                       placeholder="es. DELIV_PRICE_MENU_001" required>
                                <div class="invalid-feedback">
                                    Inserisci l'ID del prezzo prodotto Delivery.
                                </div>
                                <small class="text-muted">Identificativo del prezzo per il servizio delivery</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="selling_price" class="form-label">Prezzo di Vendita (€) *</label>
                                <div class="input-group">
                                    <span class="input-group-text">€</span>
                                    <input type="number" class="form-control" id="selling_price" name="selling_price" 
                                           step="0.0000001" min="0" max="999.9999999" placeholder="0.0000000" required>
                                </div>
                                <div class="invalid-feedback">
                                    Inserisci un prezzo di vendita valido.
                                </div>
                                <small class="text-muted">Prezzo finale del menu completo (fino a 7 decimali)</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="food_paper_cost_total" class="form-label">Food + Paper Cost Totale (€) *</label>
                                <div class="input-group">
                                    <span class="input-group-text">€</span>
                                    <input type="number" class="form-control" id="food_paper_cost_total" name="food_paper_cost_total" 
                                           step="0.0000001" min="0" max="999.9999999" placeholder="0.0000000" required>
                                </div>
                                <div class="invalid-feedback">
                                    Inserisci il costo totale Food + Paper.
                                </div>
                                <small class="text-muted">Costo totale di ingredienti + packaging</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Analisi Profitto</label>
                                <div class="card border-success">
                                    <div class="card-body p-2">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <small class="text-muted">Profitto</small>
                                                <div class="fw-bold text-success" id="gross-profit">€0.00</div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Margine</small>
                                                <div class="fw-bold" id="profit-percentage">0.0%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="mb-3">
                                <i class="bi bi-list-ul me-2"></i>Prodotti nel Menu
                            </h6>
                            
                            <div id="menu-products" class="border rounded p-3 mb-3" style="min-height: 200px;">
                                <div class="text-muted text-center py-4" id="empty-menu">
                                    <i class="bi bi-inbox display-4 d-block mb-2 opacity-50"></i>
                                    Trascina i prodotti qui per aggiungerli al menu
                                </div>
                            </div>
                            
                            <!-- Extras Selection -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="fries_size" class="form-label">
                                        <i class="bi bi-plus-circle me-1"></i>Patatine
                                    </label>
                                    <select class="form-select" id="fries_size" name="fries_size">
                                        <option value="">Nessuna</option>
                                        <option value="small">Piccole (+€2.50)</option>
                                        <option value="medium">Medie (+€3.00)</option>
                                        <option value="large">Grandi (+€3.50)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="drink_size" class="form-label">
                                        <i class="bi bi-cup-straw me-1"></i>Bibita
                                    </label>
                                    <select class="form-select" id="drink_size" name="drink_size">
                                        <option value="">Nessuna</option>
                                        <option value="small">Piccola (+€1.50)</option>
                                        <option value="medium">Media (+€2.00)</option>
                                        <option value="large">Grande (+€2.50)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Trascina e rilascia per riordinare i prodotti
                                </small>
                                <div>
                                    <strong>Costo Totale: €<span id="total-cost">0.00</span></strong>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>Salva Menu
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="clearMenu()">
                                <i class="bi bi-trash me-2"></i>Svuota Menu
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Available Products -->
        <div class="col-12 col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-grid me-2"></i>Prodotti Disponibili
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Search -->
                    <div class="mb-3">
                        <input type="text" class="form-control" id="product-search" 
                               placeholder="Cerca prodotti...">
                    </div>
                    
                    <!-- Products List -->
                    <div id="available-products" style="max-height: 500px; overflow-y: auto;">
                        {% if sandwiches %}
                            {% for product in sandwiches %}
                            <div class="product-item border rounded p-2 mb-2" draggable="true" 
                                 data-product-id="{{ product.id }}" 
                                 data-product-name="{{ product.name }}"
                                 data-product-cost="{{ product.total_cost }}"
                                 data-product-category="{{ product.product_type.upper() }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ product.name }}</h6>
                                        <small class="text-muted">
                                            <span class="badge bg-primary">{{ product.product_type.title() }}</span>
                                            Costo: €{{ "%.2f"|format(product.total_cost or 0) }}
                                        </small>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <button type="button" class="btn btn-sm btn-success add-product-btn"
                                                data-product-id="{{ product.id }}"
                                                data-product-name="{{ product.name }}"
                                                data-product-cost="{{ product.total_cost or 0 }}"
                                                data-product-category="{{ product.product_type.upper() }}"
                                                title="Aggiungi al menu">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                        <i class="bi bi-grip-vertical text-muted"></i>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-6 d-block mb-2 opacity-50"></i>
                                <p class="mb-0">Nessun prodotto disponibile</p>
                                <a href="{{ url_for('main.create_sandwich') }}" class="btn btn-sm btn-outline-primary mt-2">
                                    <i class="bi bi-plus me-1"></i>Crea Prodotto
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Menu builder functionality
let menuProducts = [];
let totalCost = 0;

// Initialize drag and drop
document.addEventListener('DOMContentLoaded', function() {
    const availableProducts = document.getElementById('available-products');
    const menuProductsContainer = document.getElementById('menu-products');
    
    // Make product items draggable
    availableProducts.addEventListener('dragstart', handleDragStart);
    
    // Setup drop zone
    menuProductsContainer.addEventListener('dragover', handleDragOver);
    menuProductsContainer.addEventListener('drop', handleDrop);
    
    // Search functionality
    document.getElementById('product-search').addEventListener('input', filterProducts);
    
    // Add product button listeners
    document.addEventListener('click', function(e) {
        if (e.target.closest('.add-product-btn')) {
            const btn = e.target.closest('.add-product-btn');
            const productData = {
                id: btn.dataset.productId,
                name: btn.dataset.productName,
                cost: parseFloat(btn.dataset.productCost),
                category: btn.dataset.productCategory
            };
            addProductToMenu(productData);
        }
    });
    
    // Extras and price listeners
    document.getElementById('fries_size').addEventListener('change', updateTotalCost);
    document.getElementById('drink_size').addEventListener('change', updateTotalCost);
    document.getElementById('selling_price').addEventListener('input', calculateProfit);
    
    // Form validation
    setupFormValidation();
});

function handleDragStart(e) {
    if (e.target.classList.contains('product-item')) {
        const productData = {
            id: e.target.dataset.productId,
            name: e.target.dataset.productName,
            cost: parseFloat(e.target.dataset.productCost),
            category: e.target.dataset.productCategory
        };
        e.dataTransfer.setData('text/plain', JSON.stringify(productData));
        e.dataTransfer.effectAllowed = 'copy';
    }
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
}

function handleDrop(e) {
    e.preventDefault();
    
    try {
        const productData = JSON.parse(e.dataTransfer.getData('text/plain'));
        addProductToMenu(productData);
    } catch (error) {
        console.error('Error parsing dropped data:', error);
    }
}

function addProductToMenu(product) {
    // Check if product already in menu
    if (menuProducts.find(p => p.id === product.id)) {
        alert('Questo prodotto è già nel menu!');
        return;
    }
    
    menuProducts.push(product);
    updateMenuDisplay();
    updateTotalCost();
}

function removeProductFromMenu(productId) {
    menuProducts = menuProducts.filter(p => p.id !== productId);
    updateMenuDisplay();
    updateTotalCost();
}

function updateMenuDisplay() {
    const container = document.getElementById('menu-products');
    const emptyState = document.getElementById('empty-menu');
    
    if (menuProducts.length === 0) {
        emptyState.style.display = 'block';
        // Clear any existing product items
        const existingItems = container.querySelectorAll('.menu-product-item');
        existingItems.forEach(item => item.remove());
    } else {
        emptyState.style.display = 'none';
        
        // Clear existing items
        const existingItems = container.querySelectorAll('.menu-product-item');
        existingItems.forEach(item => item.remove());
        
        // Add current products
        menuProducts.forEach((product, index) => {
            const productElement = createMenuProductElement(product, index);
            container.appendChild(productElement);
        });
    }
}

function createMenuProductElement(product, index) {
    const div = document.createElement('div');
    div.className = 'menu-product-item border rounded p-2 mb-2 bg-light';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-1">${product.name}</h6>
                <small class="text-muted">
                    <span class="badge bg-secondary">${product.category}</span>
                    Costo: €${product.cost.toFixed(2)}
                </small>
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        onclick="removeProductFromMenu('${product.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        <input type="hidden" name="product_ids[]" value="${product.id}">
    `;
    return div;
}

function updateTotalCost() {
    // Calculate base product costs
    const productsCost = menuProducts.reduce((sum, product) => sum + product.cost, 0);
    
    // Add fries cost
    const friesSelect = document.getElementById('fries_size');
    const friesPrices = { 'small': 2.50, 'medium': 3.00, 'large': 3.50 };
    const friesCost = friesSelect.value ? friesPrices[friesSelect.value] : 0;
    
    // Add drink cost
    const drinkSelect = document.getElementById('drink_size');
    const drinkPrices = { 'small': 1.50, 'medium': 2.00, 'large': 2.50 };
    const drinkCost = drinkSelect.value ? drinkPrices[drinkSelect.value] : 0;
    
    totalCost = productsCost + friesCost + drinkCost;
    document.getElementById('total-cost').textContent = totalCost.toFixed(2);
    
    // Update profit calculation
    calculateProfit();
}

function calculateProfit() {
    const sellingPrice = parseFloat(document.getElementById('selling_price').value) || 0;
    const grossProfit = sellingPrice - totalCost;
    const profitPercentage = sellingPrice > 0 ? (grossProfit / sellingPrice * 100) : 0;
    
    const profitElement = document.getElementById('gross-profit');
    const percentageElement = document.getElementById('profit-percentage');
    
    profitElement.textContent = `€${grossProfit.toFixed(2)}`;
    profitElement.className = `fw-bold ${grossProfit >= 0 ? 'text-success' : 'text-danger'}`;
    
    percentageElement.textContent = `${profitPercentage.toFixed(1)}%`;
    percentageElement.className = `fw-bold ${profitPercentage >= 0 ? 'text-success' : 'text-danger'}`;
}

function clearMenu() {
    if (menuProducts.length > 0 && confirm('Sei sicuro di voler svuotare il menu?')) {
        menuProducts = [];
        updateMenuDisplay();
        updateTotalCost();
    }
}

function filterProducts() {
    const searchTerm = document.getElementById('product-search').value.toLowerCase();
    const productItems = document.querySelectorAll('#available-products .product-item');
    
    productItems.forEach(item => {
        const productName = item.dataset.productName.toLowerCase();
        const productCategory = item.dataset.productCategory.toLowerCase();
        
        if (productName.includes(searchTerm) || productCategory.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function setupFormValidation() {
    const form = document.getElementById('menuForm');
    
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity() || menuProducts.length === 0) {
            event.preventDefault();
            event.stopPropagation();
            
            if (menuProducts.length === 0) {
                alert('Aggiungi almeno un prodotto al menu!');
            }
        } else {
            // Add sandwich_id as the first product for backend compatibility
            if (menuProducts.length > 0) {
                const sandwichIdInput = document.createElement('input');
                sandwichIdInput.type = 'hidden';
                sandwichIdInput.name = 'sandwich_id';
                sandwichIdInput.value = menuProducts[0].id;
                form.appendChild(sandwichIdInput);
            }
        }
        
        form.classList.add('was-validated');
    });
}

// Styling for drag and drop
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .product-item {
            cursor: grab;
            transition: all 0.2s ease;
        }
        .product-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .product-item:active {
            cursor: grabbing;
        }
        #menu-products {
            border: 2px dashed #dee2e6 !important;
            transition: all 0.2s ease;
        }
        #menu-products:hover {
            border-color: #007bff !important;
            background-color: #f8f9fa;
        }
        .add-product-btn {
            opacity: 0.7;
            transition: all 0.2s ease;
        }
        .product-item:hover .add-product-btn {
            opacity: 1;
            transform: scale(1.1);
        }
        .add-product-btn:hover {
            transform: scale(1.2) !important;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}