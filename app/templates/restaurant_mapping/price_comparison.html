{% extends "base.html" %}

{% block title %}Confronto Prezzi - Menu Builder{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-graph-up me-2 text-primary"></i>Confronto Prezzi
                    </h1>
                    <p class="text-muted mb-0">Analizza e confronta i prezzi dei prodotti tra i ristoranti</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('restaurant_mapping.index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Torna alla Mappa
                    </a>
                    <button class="btn btn-outline-primary" onclick="exportComparison()">
                        <i class="bi bi-download me-1"></i>Esporta CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="product-filter" class="form-label">Filtra per Prodotto</label>
                            <input type="text" class="form-control" id="product-filter" 
                                   placeholder="Cerca prodotti...">
                        </div>
                        <div class="col-md-3">
                            <label for="restaurant-filter" class="form-label">Ristoranti</label>
                            <select class="form-select" id="restaurant-filter" multiple>
                                {% for restaurant in restaurants %}
                                <option value="{{ restaurant.id }}">{{ restaurant.name }} - {{ restaurant.city }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Ctrl+click per selezione multipla</small>
                        </div>
                        <div class="col-md-2">
                            <label for="category-filter" class="form-label">Categoria</label>
                            <select class="form-select" id="category-filter">
                                <option value="">Tutte</option>
                                <option value="product">Prodotti</option>
                                <option value="menu">Menu</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="sort-filter" class="form-label">Ordina per</label>
                            <select class="form-select" id="sort-filter">
                                <option value="name">Nome Prodotto</option>
                                <option value="min_price">Prezzo Minimo</option>
                                <option value="max_price">Prezzo Massimo</option>
                                <option value="price_range">Variazione Prezzo</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="bi bi-funnel me-1"></i>Applica
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    {% if comparison_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-graph-up me-2"></i>Analisi Gross Profit
                        </h5>
                        <div class="d-flex gap-2">
                            <button id="toggle-charts-btn" class="btn btn-outline-secondary btn-sm" onclick="toggleCharts()">
                                <i class="bi bi-eye me-1"></i>Mostra Grafici
                            </button>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="chart-type" id="chart-onsite" autocomplete="off" checked>
                                <label class="btn btn-outline-primary btn-sm" for="chart-onsite">On Site</label>
                                <input type="radio" class="btn-check" name="chart-type" id="chart-delivery" autocomplete="off">
                                <label class="btn btn-outline-info btn-sm" for="chart-delivery">Delivery</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body" id="charts-container" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Seleziona Ristoranti per il Grafico:</label>
                            <div class="d-flex flex-wrap gap-2" id="restaurant-chart-filters">
                                <button class="btn btn-sm btn-outline-secondary" onclick="selectAllRestaurants()">Tutti</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearAllRestaurants()">Nessuno</button>
                                {% set processed_restaurants = [] %}
                                {% for item in comparison_data %}
                                    {% for listing in item.listings %}
                                        {% if listing.restaurant_id not in processed_restaurants %}
                                            {% set _ = processed_restaurants.append(listing.restaurant_id) %}
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input restaurant-chart-filter" type="checkbox" 
                                                       id="chart-restaurant-{{ listing.restaurant_id }}" 
                                                       value="{{ listing.restaurant_id }}" checked>
                                                <label class="form-check-label" for="chart-restaurant-{{ listing.restaurant_id }}">
                                                    {{ listing.restaurant_name }}
                                                </label>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <canvas id="profit-chart" width="400" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comparison Results -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table me-2"></i>Confronto Prezzi ({{ comparison_data|length }} prodotti)
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0" id="comparison-table">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 25%">
                                        <i class="bi bi-box-seam me-2"></i>Prodotto
                                    </th>
                                    <th style="width: 12%">
                                        <i class="bi bi-tags me-2"></i>Categoria
                                    </th>
                                    <th style="width: 10%">
                                        <i class="bi bi-cash-stack me-2"></i>F&P Cost
                                    </th>
                                    <th style="width: 30%">
                                        <i class="bi bi-currency-euro me-2"></i>Prezzi per Ristorante
                                    </th>
                                    <th style="width: 23%">
                                        <i class="bi bi-graph-up me-2"></i>Gross Profit
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in comparison_data %}
                                <tr class="comparison-row" 
                                    data-product-name="{{ item.product.name.lower() }}"
                                    data-product-category="{{ item.product.product_type.lower() }}"
                                    data-min-price="{{ item.min_price }}"
                                    data-max-price="{{ item.max_price }}"
                                    data-price-range="{{ item.price_range }}"
                                    data-restaurants="{{ item.listings|map(attribute='restaurant_id')|join(',') }}">
                                    <td>
                                        <div>
                                            <strong>{{ item.product.name }}</strong>
                                            <br><small class="text-muted">#{{ item.product.id }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {{ item.product.product_type.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong class="text-danger">€{{ "%.3f"|format(item.product.food_paper_cost_total or 0) }}</strong>
                                        {% if item.product.product_type == 'menu' and item.product.base_product %}
                                            <br><small class="text-muted">
                                                Base: €{{ "%.3f"|format(item.product.base_product.food_paper_cost_total or 0) }}
                                                {% if item.product.fries_fp_cost %} + Patatine: €{{ "%.3f"|format(item.product.fries_fp_cost) }}{% endif %}
                                                {% if item.product.drink_fp_cost %} + Bibita: €{{ "%.3f"|format(item.product.drink_fp_cost) }}{% endif %}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="restaurant-prices">
                                            {% for listing in item.listings %}
                                            <div class="price-item mb-2 p-2 bg-light rounded">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>{{ listing.restaurant_name }}</strong>
                                                        <br><small class="text-muted">{{ listing.city }}</small>
                                                        {% if not listing.is_available %}
                                                        <br><span class="badge bg-warning text-dark">Non Disponibile</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="fw-bold text-primary">€{{ "%.2f"|format(listing.local_price) }}</div>
                                                        <small class="text-muted">On Site</small>
                                                        <br>
                                                        <div class="fw-bold text-info">€{{ "%.2f"|format(listing.delivery_price) }}</div>
                                                        <small class="text-muted">Delivery</small>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="restaurant-profits">
                                            {% for listing in item.listings %}
                                            <div class="profit-item mb-2 p-2 bg-light rounded">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="text-center">
                                                            <div class="fw-bold {{ 'text-success' if listing.local_profit >= 0 else 'text-danger' }}">
                                                                €{{ "%.2f"|format(listing.local_profit) }}
                                                            </div>
                                                            <small class="text-muted">On Site</small>
                                                            <br><small class="{{ 'text-success' if listing.local_profit >= 0 else 'text-danger' }}">
                                                                {{ "%.1f"|format(listing.local_margin) }}%
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center">
                                                            <div class="fw-bold {{ 'text-success' if listing.delivery_profit >= 0 else 'text-danger' }}">
                                                                €{{ "%.2f"|format(listing.delivery_profit) }}
                                                            </div>
                                                            <small class="text-muted">Delivery</small>
                                                            <br><small class="{{ 'text-success' if listing.delivery_profit >= 0 else 'text-danger' }}">
                                                                {{ "%.1f"|format(listing.delivery_margin) }}%
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-graph-up display-1 text-muted opacity-50"></i>
                    <h3 class="mt-3">Nessun Dato di Confronto</h3>
                    <p class="text-muted">
                        Non ci sono prodotti con listini configurati per il confronto prezzi.
                    </p>
                    <div class="mt-3">
                        <a href="{{ url_for('restaurant_mapping.restaurants') }}" class="btn btn-primary">
                            <i class="bi bi-building me-2"></i>Gestisci Ristoranti
                        </a>
                        <a href="{{ url_for('main.create_sandwich') }}" class="btn btn-outline-primary ms-2">
                            <i class="bi bi-plus-circle me-2"></i>Crea Prodotti
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
.comparison-row:hover {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.profit-positive {
    background: linear-gradient(90deg, rgba(25, 135, 84, 0.1) 0%, transparent 100%);
}

.profit-negative {
    background: linear-gradient(90deg, rgba(220, 53, 69, 0.1) 0%, transparent 100%);
}

.restaurant-prices .price-item {
    border-left: 3px solid #007bff;
    transition: all 0.3s ease;
}

.restaurant-prices .price-item:hover {
    border-left-color: #0056b3;
    transform: translateX(2px);
}

.profit-item {
    transition: all 0.2s ease;
    border-radius: 8px !important;
}

.profit-item:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#comparison-table th {
    position: sticky;
    top: 0;
    z-index: 10;
}

.table-dark th {
    background-color: #212529 !important;
    color: #fff !important;
    font-weight: 600;
    letter-spacing: 0.5px;
}
</style>

<script>
let originalData = [];
let profitChart = null;
let chartsVisible = false;


// Extract data from template for charts
const comparisonData = [
    {% for item in comparison_data %}
    {
        productName: "{{ item.product.name|e }}",
        productType: "{{ item.product.product_type }}",
        fpCost: {{ item.product.food_paper_cost_total or 0 }},
        listings: [
            {% for listing in item.listings %}
            {
                restaurantId: {{ listing.restaurant_id }},
                restaurantName: "{{ listing.restaurant_name|e }}",
                localPrice: {{ listing.local_price }},
                deliveryPrice: {{ listing.delivery_price }},
                localProfit: {{ listing.local_profit }},
                deliveryProfit: {{ listing.delivery_profit }},
                localMargin: {{ listing.local_margin }},
                deliveryMargin: {{ listing.delivery_margin }},
                isAvailable: {{ 'true' if listing.is_available else 'false' }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Toggle charts visibility
function toggleCharts() {
    const container = document.getElementById('charts-container');
    const btn = document.getElementById('toggle-charts-btn');
    
    if (chartsVisible) {
        container.style.display = 'none';
        btn.innerHTML = '<i class="bi bi-eye me-1"></i>Mostra Grafici';
        chartsVisible = false;
    } else {
        container.style.display = 'block';
        btn.innerHTML = '<i class="bi bi-eye-slash me-1"></i>Nascondi Grafici';
        chartsVisible = true;
        updateChart();
    }
}

// Update chart based on selected filters
function updateChart() {
    if (!profitChart || !chartsVisible) return;
    
    const chartType = document.querySelector('input[name="chart-type"]:checked').id;
    const isDelivery = chartType === 'chart-delivery';
    
    const selectedRestaurants = Array.from(document.querySelectorAll('.restaurant-chart-filter:checked'))
        .map(cb => parseInt(cb.value));
    
    if (selectedRestaurants.length === 0) return;
    
    const chartData = [];
    const chartLabels = [];
    
    comparisonData.forEach(item => {
        const filteredListings = item.listings.filter(listing => 
            selectedRestaurants.includes(listing.restaurantId) && listing.isAvailable
        );
        
        if (filteredListings.length > 0) {
            const avgProfit = filteredListings.reduce((sum, listing) => 
                sum + (isDelivery ? listing.deliveryProfit : listing.localProfit), 0
            ) / filteredListings.length;
            
            chartData.push(avgProfit);
            chartLabels.push(item.productName);
        }
    });
    
    profitChart.data.labels = chartLabels;
    profitChart.data.datasets[0].data = chartData;
    profitChart.data.datasets[0].label = isDelivery ? 'Gross Profit Delivery (€)' : 'Gross Profit On Site (€)';
    profitChart.data.datasets[0].backgroundColor = isDelivery ? 
        'rgba(23, 162, 184, 0.6)' : 'rgba(54, 162, 235, 0.6)';
    profitChart.data.datasets[0].borderColor = isDelivery ? 
        'rgba(23, 162, 184, 1)' : 'rgba(54, 162, 235, 1)';
    
    profitChart.update();
}

// Restaurant selection functions
function selectAllRestaurants() {
    document.querySelectorAll('.restaurant-chart-filter').forEach(cb => {
        cb.checked = true;
    });
    updateChart();
}

function clearAllRestaurants() {
    document.querySelectorAll('.restaurant-chart-filter').forEach(cb => {
        cb.checked = false;
    });
    updateChart();
}

// Table filtering function
function filterTable() {
    const productFilter = document.getElementById('product-filter').value.toLowerCase();
    const restaurantFilter = Array.from(document.getElementById('restaurant-filter').selectedOptions).map(opt => opt.value);
    const categoryFilter = document.getElementById('category-filter').value.toLowerCase();
    
    document.querySelectorAll('.comparison-row').forEach(row => {
        const productName = row.dataset.productName || '';
        const productCategory = row.dataset.productCategory || '';
        
        const nameMatch = !productFilter || productName.includes(productFilter);
        const categoryMatch = !categoryFilter || productCategory.includes(categoryFilter);
        const restaurantMatch = restaurantFilter.length === 0;
        
        if (nameMatch && categoryMatch && restaurantMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    setupEventListeners();
    applyRowStyles()
});

// Initialize the profit chart
function initializeChart() {
    const ctx = document.getElementById('profit-chart').getContext('2d');
    
    profitChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Gross Profit (€)',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Gross Profit (€)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Prodotti'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Gross Profit: €${context.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });
}

// Setup event listeners
function setupEventListeners() {
    // Chart type radio buttons
    document.querySelectorAll('input[name="chart-type"]').forEach(radio => {
        radio.addEventListener('change', updateChart);
    });
    
    // Restaurant filters
    document.querySelectorAll('.restaurant-chart-filter').forEach(checkbox => {
        checkbox.addEventListener('change', updateChart);
    });
    
    // Table filters
    document.getElementById('product-filter').addEventListener('input', filterTable);
    document.getElementById('restaurant-filter').addEventListener('change', filterTable);
    document.getElementById('category-filter').addEventListener('change', filterTable);
    document.getElementById('sort-filter').addEventListener('change', filterTable);
}

// Apply visual enhancements to table rows
function applyRowStyles() {
    const rows = document.querySelectorAll('.comparison-row');
    rows.forEach(row => {
        // Apply profit-based styling
        const profitItems = row.querySelectorAll('.profit-item');
        profitItems.forEach(item => {
            const profitValue = parseFloat(item.querySelector('.fw-bold').textContent.replace(/[€,]/g, ''));
            if (profitValue > 0) {
                item.classList.add('profit-positive');
            } else if (profitValue < 0) {
                item.classList.add('profit-negative');
            }
        });
        
        // Store row data for filtering
        originalData.push({
            element: row,
            name: row.dataset.productName,
            category: row.dataset.productCategory,
            restaurants: row.dataset.restaurants.split(',').map(id => parseInt(id))
        });
    });
    
    calculateSummaryStats();
    initializeCharts();
    updateCharts(originalData);
    
    // Set up real-time filtering
    document.getElementById('product-filter').addEventListener('input', applyFilters);
    document.getElementById('restaurant-filter').addEventListener('change', applyFilters);
    document.getElementById('category-filter').addEventListener('change', applyFilters);
    document.getElementById('sort-filter').addEventListener('change', applyFilters);
};

function applyFilters() {
    const productFilter = document.getElementById('product-filter').value.toLowerCase();
    const restaurantFilter = Array.from(document.getElementById('restaurant-filter').selectedOptions).map(opt => parseInt(opt.value));
    const categoryFilter = document.getElementById('category-filter').value.toLowerCase();
    const sortBy = document.getElementById('sort-filter').value;
    
    // Filter data
    let filteredData = originalData.filter(item => {
        const nameMatch = !productFilter || item.name.includes(productFilter);
        const categoryMatch = !categoryFilter || item.category === categoryFilter;
        const restaurantMatch = restaurantFilter.length === 0 || item.restaurants.some(rid => restaurantFilter.includes(rid));
        return nameMatch && categoryMatch && restaurantMatch;
    });
    
    // Sort data
    filteredData.sort((a, b) => {
        switch(sortBy) {
            case 'name':
                return a.name.localeCompare(b.name);
            case 'min_price':
                return a.minPrice - b.minPrice;
            case 'max_price':
                return b.maxPrice - a.maxPrice;
            case 'price_range':
                return b.priceRange - a.priceRange;
            default:
                return 0;
        }
    });
    
    // Update table
    const tbody = document.querySelector('#comparison-table tbody');
    tbody.innerHTML = '';
    
    filteredData.forEach(item => {
        tbody.appendChild(item.element);
    });
    
    // Update stats and charts
    calculateSummaryStats(filteredData);
    updateCharts(filteredData);
}

function calculateSummaryStats(data = originalData) {
    if (data.length === 0) return;
    
    const totalProducts = data.length;
    const avgMinPrice = data.reduce((sum, item) => sum + item.minPrice, 0) / totalProducts;
    const avgMaxPrice = data.reduce((sum, item) => sum + item.maxPrice, 0) / totalProducts;
    const avgPriceRange = data.reduce((sum, item) => sum + item.priceRange, 0) / totalProducts;
    const maxVariation = Math.max(...data.map(item => item.priceRange));
    
    const highVariationCount = data.filter(item => item.priceRange > avgPriceRange).length;
    
    const statsContainer = document.getElementById('summary-stats');
    statsContainer.innerHTML = `
        <div class="col-md-2">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4>${totalProducts}</h4>
                    <small>Prodotti Confrontati</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4>€${avgMinPrice.toFixed(2)}</h4>
                    <small>Prezzo Min Medio</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h4>€${avgMaxPrice.toFixed(2)}</h4>
                    <small>Prezzo Max Medio</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4>€${avgPriceRange.toFixed(2)}</h4>
                    <small>Variazione Media</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4>€${maxVariation.toFixed(2)}</h4>
                    <small>Max Variazione</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h4>${highVariationCount}</h4>
                    <small>Alta Variazione</small>
                </div>
            </div>
        </div>
    `;
}

function exportComparison() {
    // Generate CSV content
    let csv = 'Prodotto,Categoria,Ristorante,Città,Prezzo Locale,Prezzo Delivery,Markup,Disponibile\\n';
    
    const rows = document.querySelectorAll('.comparison-row:not([style*="display: none"])');
    rows.forEach(row => {
        const productName = row.querySelector('strong').textContent;
        const category = row.querySelector('.badge').textContent;
        
        const priceItems = row.querySelectorAll('.price-item');
        priceItems.forEach(item => {
            const restaurantName = item.querySelector('strong').textContent;
            const city = item.querySelector('.text-muted').textContent.replace(/[()]/g, '');
            const isAvailable = !item.querySelector('.badge.bg-warning');
            
            const prices = item.querySelectorAll('.fw-bold');
            const localPrice = prices[0].textContent.replace('€', '');
            const deliveryPrice = prices[1].textContent.replace('€', '');
            const markup = (parseFloat(deliveryPrice) - parseFloat(localPrice)).toFixed(2);
            
            csv += `"${productName}","${category}","${restaurantName}","${city}",${localPrice},${deliveryPrice},${markup},"${isAvailable ? 'Sì' : 'No'}"\\n`;
        });
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `confronto_prezzi_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function initializeCharts() {
    // Initialize On Site Gross Profit Chart
    const onSiteCtx = document.getElementById('grossProfitOnSiteChart').getContext('2d');
    charts.grossProfitOnSite = new Chart(onSiteCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Gross Profit On Site (€)',
                data: [],
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '€' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });

    // Initialize Delivery Gross Profit Chart
    const deliveryCtx = document.getElementById('grossProfitDeliveryChart').getContext('2d');
    charts.grossProfitDelivery = new Chart(deliveryCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Gross Profit Delivery (€)',
                data: [],
                backgroundColor: 'rgba(23, 162, 184, 0.8)',
                borderColor: 'rgba(23, 162, 184, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '€' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });

    // Initialize Profit Comparison Chart
    const comparisonCtx = document.getElementById('profitComparisonChart').getContext('2d');
    charts.profitComparison = new Chart(comparisonCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'On Site Profit (%)',
                    data: [],
                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 2,
                    tension: 0.4
                },
                {
                    label: 'Delivery Profit (%)',
                    data: [],
                    backgroundColor: 'rgba(23, 162, 184, 0.2)',
                    borderColor: 'rgba(23, 162, 184, 1)',
                    borderWidth: 2,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

function updateCharts(filteredData) {
    if (filteredData.length === 0) {
        // Clear all charts
        Object.values(charts).forEach(chart => {
            chart.data.labels = [];
            chart.data.datasets.forEach(dataset => dataset.data = []);
            chart.update();
        });
        return;
    }

    // We need to parse data from the table since we don't have structured data in JS
    // This is a simplified approach - for now we'll aggregate basic profit data
    const restaurantData = {};
    
    filteredData.forEach(item => {
        const row = item.element;
        const profitItems = row.querySelectorAll('.profit-item');
        
        profitItems.forEach(profitItem => {
            const restaurantName = profitItem.querySelector('strong').textContent;
            
            // Extract profit values
            const profitValues = profitItem.querySelectorAll('.fw-bold');
            if (profitValues.length >= 2) {
                const onSiteProfit = parseFloat(profitValues[0].textContent.replace('€', ''));
                const deliveryProfit = parseFloat(profitValues[1].textContent.replace('€', ''));
                
                // Extract percentages
                const percentages = profitItem.querySelectorAll('small');
                let onSitePercent = 0, deliveryPercent = 0;
                percentages.forEach(small => {
                    const text = small.textContent;
                    if (text.includes('%')) {
                        const percent = parseFloat(text.replace('%', ''));
                        if (small.closest('.col-6').previousElementSibling === null) {
                            onSitePercent = percent;
                        } else {
                            deliveryPercent = percent;
                        }
                    }
                });
                
                if (!restaurantData[restaurantName]) {
                    restaurantData[restaurantName] = {
                        onSiteProfits: [],
                        deliveryProfits: [],
                        onSitePercents: [],
                        deliveryPercents: []
                    };
                }
                
                restaurantData[restaurantName].onSiteProfits.push(onSiteProfit);
                restaurantData[restaurantName].deliveryProfits.push(deliveryProfit);
                restaurantData[restaurantName].onSitePercents.push(onSitePercent);
                restaurantData[restaurantName].deliveryPercents.push(deliveryPercent);
            }
        });
    });

    // Calculate averages
    const restaurants = Object.keys(restaurantData);
    const onSiteAvgs = restaurants.map(name => {
        const profits = restaurantData[name].onSiteProfits;
        return profits.length > 0 ? profits.reduce((sum, p) => sum + p, 0) / profits.length : 0;
    });
    const deliveryAvgs = restaurants.map(name => {
        const profits = restaurantData[name].deliveryProfits;
        return profits.length > 0 ? profits.reduce((sum, p) => sum + p, 0) / profits.length : 0;
    });
    const onSitePercentAvgs = restaurants.map(name => {
        const percents = restaurantData[name].onSitePercents;
        return percents.length > 0 ? percents.reduce((sum, p) => sum + p, 0) / percents.length : 0;
    });
    const deliveryPercentAvgs = restaurants.map(name => {
        const percents = restaurantData[name].deliveryPercents;
        return percents.length > 0 ? percents.reduce((sum, p) => sum + p, 0) / percents.length : 0;
    });

    // Update On Site Chart
    charts.grossProfitOnSite.data.labels = restaurants;
    charts.grossProfitOnSite.data.datasets[0].data = onSiteAvgs;
    charts.grossProfitOnSite.update();

    // Update Delivery Chart
    charts.grossProfitDelivery.data.labels = restaurants;
    charts.grossProfitDelivery.data.datasets[0].data = deliveryAvgs;
    charts.grossProfitDelivery.update();

    // Update Comparison Chart
    charts.profitComparison.data.labels = restaurants;
    charts.profitComparison.data.datasets[0].data = onSitePercentAvgs;
    charts.profitComparison.data.datasets[1].data = deliveryPercentAvgs;
    charts.profitComparison.update();
}
</script>
{% endblock %}