{% extends "base.html" %}

{% block title %}Mappa Ristoranti - Menu Builder{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-geo-alt me-2 text-primary"></i>Mappa Ristoranti Interattiva
                    </h1>
                    <p class="text-muted mb-0">Mappa interattiva personalizzata senza dipendenze esterne</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('restaurant_mapping.restaurants') }}" class="btn btn-outline-primary">
                        <i class="bi bi-building me-1"></i>Gestisci Ristoranti
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="mb-0">{{ stats.total_restaurants }}</h3>
                            <small>Ristoranti Totali</small>
                        </div>
                        <i class="bi bi-building display-6 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="mb-0">{{ stats.restaurants_with_coords }}</h3>
                            <small>Su Mappa</small>
                        </div>
                        <i class="bi bi-geo-alt display-6 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="mb-0">{{ stats.total_products_listed }}</h3>
                            <small>Prodotti Listati</small>
                        </div>
                        <i class="bi bi-box display-6 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="mb-0">{{ stats.avg_products_per_restaurant }}</h3>
                            <small>Media Prodotti/Ristorante</small>
                        </div>
                        <i class="bi bi-graph-up display-6 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Interactive Map -->
        <div class="col-12 col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-map me-2"></i>Mappa Interattiva Italia
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button id="zoom-in" class="btn btn-outline-secondary" onclick="zoomIn()">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                            <button id="zoom-out" class="btn btn-outline-secondary" onclick="zoomOut()">
                                <i class="bi bi-zoom-out"></i>
                            </button>
                            <button id="reset-view" class="btn btn-outline-secondary" onclick="resetView()">
                                <i class="bi bi-arrows-fullscreen"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="interactive-map" style="height: 500px; width: 100%; position: relative; overflow: hidden; background: #f8f9fa;">
                        <svg id="map-svg" width="100%" height="100%" style="cursor: move;">
                            <!-- Italy outline (simplified) -->
                            <defs>
                                <pattern id="italyPattern" patternUnits="userSpaceOnUse" width="4" height="4">
                                    <rect width="4" height="4" fill="#e9ecef"/>
                                    <path d="m 0,4 l 4,-4 M -1,1 l 2,-2 M 3,5 l 2,-2" stroke="#dee2e6" stroke-width="1"/>
                                </pattern>
                            </defs>
                            
                            <!-- Simplified Italy map -->
                            <g id="italy-map" transform="translate(50, 50) scale(1)">
                                <!-- Italy mainland -->
                                <path d="M 200 50 Q 220 30 250 40 Q 280 45 300 70 Q 310 90 320 120 L 330 150 Q 335 180 340 210 Q 345 240 350 270 Q 355 300 360 330 Q 365 360 370 390 Q 375 420 380 450 L 385 480 Q 380 490 370 485 Q 360 480 350 475 L 340 470 Q 330 465 320 460 L 310 455 Q 300 450 290 445 L 280 440 Q 270 435 260 430 L 250 425 Q 240 420 230 415 L 220 410 Q 210 405 200 400 L 190 395 Q 180 390 170 385 L 160 380 Q 150 375 140 370 L 130 365 Q 125 360 130 355 L 135 350 Q 140 345 145 340 L 150 335 Q 155 330 160 325 L 165 320 Q 170 315 175 310 L 180 305 Q 185 300 190 295 L 195 290 Q 200 285 195 280 L 190 275 Q 185 270 180 265 L 175 260 Q 170 255 165 250 L 160 245 Q 155 240 150 235 L 145 230 Q 140 225 135 220 L 130 215 Q 125 210 120 205 L 115 200 Q 110 195 105 190 L 100 185 Q 95 180 90 175 L 85 170 Q 80 165 85 160 L 90 155 Q 95 150 100 145 L 105 140 Q 110 135 115 130 L 120 125 Q 125 120 130 115 L 135 110 Q 140 105 145 100 L 150 95 Q 155 90 160 85 L 165 80 Q 170 75 175 70 L 180 65 Q 185 60 190 55 L 195 50 Q 190 45 195 40 L 200 50 Z" 
                                      fill="url(#italyPattern)" stroke="#6c757d" stroke-width="2" opacity="0.7"/>
                                
                                <!-- Sicily -->
                                <path d="M 320 460 Q 340 470 360 465 Q 380 460 390 475 Q 385 485 375 490 Q 365 485 355 480 Q 345 475 335 470 Q 325 465 320 460 Z" 
                                      fill="url(#italyPattern)" stroke="#6c757d" stroke-width="2" opacity="0.7"/>
                                
                                <!-- Sardinia -->
                                <path d="M 80 200 Q 100 190 110 210 Q 115 230 120 250 Q 125 270 120 290 Q 115 310 110 330 Q 105 350 95 360 Q 85 355 80 345 Q 75 335 70 325 Q 65 315 60 305 Q 55 295 60 285 Q 65 275 70 265 Q 75 255 80 245 Q 85 235 80 225 Q 75 215 80 200 Z" 
                                      fill="url(#italyPattern)" stroke="#6c757d" stroke-width="2" opacity="0.7"/>
                            </g>
                            
                            <!-- Restaurants will be added here -->
                            <g id="restaurants-layer"></g>
                            
                            <!-- Grid lines for reference -->
                            <g id="grid-lines" opacity="0.2">
                                <defs>
                                    <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                                        <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#adb5bd" stroke-width="1"/>
                                    </pattern>
                                </defs>
                                <rect width="100%" height="100%" fill="url(#grid)" />
                            </g>
                        </svg>
                        
                        <!-- Tooltip -->
                        <div id="map-tooltip" style="position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; z-index: 1000; display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Restaurant Controls -->
        <div class="col-12 col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list me-2"></i>Controlli Mappa
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Filtri Ristoranti</label>
                        <div class="btn-group d-flex" role="group">
                            <input type="radio" class="btn-check" name="restaurant-filter" id="filter-all" value="all" checked>
                            <label class="btn btn-outline-primary" for="filter-all">Tutti</label>

                            <input type="radio" class="btn-check" name="restaurant-filter" id="filter-open" value="open">
                            <label class="btn btn-outline-success" for="filter-open">Aperti</label>

                            <input type="radio" class="btn-check" name="restaurant-filter" id="filter-closed" value="closed">
                            <label class="btn btn-outline-danger" for="filter-closed">Chiusi</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="restaurant-search" class="form-label">Cerca Ristorante</label>
                        <input type="text" class="form-control" id="restaurant-search" placeholder="Nome o citt√†...">
                    </div>

                    <div class="d-grid gap-2 mb-3">
                        {% if current_user.is_manager() %}
                        <a href="{{ url_for('restaurant_mapping.create_restaurant') }}" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i>Nuovo Ristorante
                        </a>
                        <a href="{{ url_for('restaurant_mapping.import_page') }}" class="btn btn-info">
                            <i class="bi bi-upload me-2"></i>Importa CSV
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Restaurants List -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-building me-2"></i>Ristoranti sulla Mappa
                    </h6>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="restaurants-list">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restaurant Detail Modal -->
<div class="modal fade" id="restaurantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restaurantModalTitle">Dettagli Ristorante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="restaurantModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <a id="restaurantDetailLink" href="#" class="btn btn-primary">Visualizza Dettagli Completi</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Map data and state
let restaurantsData = [];
let mapScale = 1;
let mapTranslateX = 0;
let mapTranslateY = 0;
let isDragging = false;
let lastMouseX = 0;
let lastMouseY = 0;

// Initialize map
document.addEventListener('DOMContentLoaded', function() {
    loadRestaurantsData();
    setupMapControls();
    setupFilters();
});

function loadRestaurantsData() {
    fetch('{{ url_for("restaurant_mapping.restaurants_geojson") }}')
        .then(response => response.json())
        .then(data => {
            restaurantsData = data.features;
            displayRestaurantsOnMap(restaurantsData);
            updateRestaurantsList(restaurantsData);
        })
        .catch(error => {
            console.error('Error loading restaurants data:', error);
            document.getElementById('restaurants-layer').innerHTML = `
                <text x="250" y="250" text-anchor="middle" fill="#dc3545" font-size="14">
                    Errore caricamento ristoranti
                </text>
            `;
        });
}

function displayRestaurantsOnMap(restaurants) {
    const restaurantsLayer = document.getElementById('restaurants-layer');
    restaurantsLayer.innerHTML = '';
    
    restaurants.forEach(restaurant => {
        if (!restaurant.geometry || !restaurant.geometry.coordinates) return;
        
        const [lng, lat] = restaurant.geometry.coordinates;
        
        // Convert GPS coordinates to map coordinates (simplified projection)
        // Italy bounds approximately: lat 36-47, lng 6-18
        const x = ((lng - 6) / (18 - 6)) * 400 + 100;
        const y = 400 - ((lat - 36) / (47 - 36)) * 400 + 100;
        
        const props = restaurant.properties;
        const isOpen = props.is_open;
        
        // Create restaurant marker
        const marker = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        marker.setAttribute('class', 'restaurant-marker');
        marker.setAttribute('data-restaurant-id', props.id);
        marker.setAttribute('data-open', isOpen);
        marker.setAttribute('data-name', props.name.toLowerCase());
        marker.setAttribute('data-city', props.city.toLowerCase());
        marker.style.cursor = 'pointer';
        
        // Marker circle
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', '8');
        circle.setAttribute('fill', isOpen ? '#28a745' : '#dc3545');
        circle.setAttribute('stroke', '#ffffff');
        circle.setAttribute('stroke-width', '2');
        circle.setAttribute('opacity', '0.9');
        
        // Marker icon (restaurant symbol)
        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        icon.setAttribute('x', x);
        icon.setAttribute('y', y + 1);
        icon.setAttribute('text-anchor', 'middle');
        icon.setAttribute('font-family', 'Bootstrap Icons');
        icon.setAttribute('font-size', '8');
        icon.setAttribute('fill', '#ffffff');
        icon.textContent = 'üçΩÔ∏è';
        
        // Add hover effects
        marker.addEventListener('mouseenter', function(e) {
            circle.setAttribute('r', '12');
            circle.setAttribute('opacity', '1');
            showTooltip(e, props);
        });
        
        marker.addEventListener('mouseleave', function() {
            circle.setAttribute('r', '8');
            circle.setAttribute('opacity', '0.9');
            hideTooltip();
        });
        
        marker.addEventListener('click', function() {
            showRestaurantModal(props);
        });
        
        marker.appendChild(circle);
        marker.appendChild(icon);
        restaurantsLayer.appendChild(marker);
    });
}

function showTooltip(event, restaurant) {
    const tooltip = document.getElementById('map-tooltip');
    tooltip.innerHTML = `
        <strong>${restaurant.name}</strong><br>
        ${restaurant.address}<br>
        ${restaurant.city}<br>
        <span class="badge ${restaurant.is_open ? 'bg-success' : 'bg-danger'}">
            ${restaurant.is_open ? 'Aperto' : 'Chiuso'}
        </span>
        <span class="badge bg-info">${restaurant.listings_count} prodotti</span>
    `;
    tooltip.style.display = 'block';
    updateTooltipPosition(event);
}

function updateTooltipPosition(event) {
    const tooltip = document.getElementById('map-tooltip');
    const mapRect = document.getElementById('interactive-map').getBoundingClientRect();
    const x = event.clientX - mapRect.left + 10;
    const y = event.clientY - mapRect.top - 10;
    
    tooltip.style.left = x + 'px';
    tooltip.style.top = y + 'px';
}

function hideTooltip() {
    document.getElementById('map-tooltip').style.display = 'none';
}

function showRestaurantModal(restaurant) {
    document.getElementById('restaurantModalTitle').textContent = restaurant.name;
    document.getElementById('restaurantDetailLink').href = `/restaurant-mapping/restaurants/${restaurant.id}`;
    
    const modalBody = document.getElementById('restaurantModalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Indirizzo:</strong><br>${restaurant.address}, ${restaurant.city}</p>
                <p><strong>Codice:</strong> <code>${restaurant.restaurant_code}</code></p>
                ${restaurant.phone ? `<p><strong>Telefono:</strong> ${restaurant.phone}</p>` : ''}
            </div>
            <div class="col-md-6">
                <p><strong>Stato:</strong> 
                    <span class="badge ${restaurant.is_open ? 'bg-success' : 'bg-danger'}">
                        ${restaurant.is_open ? 'Aperto' : 'Chiuso'}
                    </span>
                </p>
                <p><strong>Prodotti:</strong> 
                    <span class="badge bg-info">${restaurant.listings_count}</span>
                </p>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('restaurantModal'));
    modal.show();
}

function updateRestaurantsList(restaurants) {
    const list = document.getElementById('restaurants-list');
    if (restaurants.length === 0) {
        list.innerHTML = '<p class="text-muted text-center">Nessun ristorante trovato</p>';
        return;
    }
    
    list.innerHTML = restaurants.map(restaurant => `
        <div class="border rounded p-2 mb-2 restaurant-list-item" data-restaurant-id="${restaurant.properties.id}">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="fw-bold">${restaurant.properties.name}</small><br>
                    <small class="text-muted">${restaurant.properties.city}</small>
                </div>
                <div>
                    <span class="badge ${restaurant.properties.is_open ? 'bg-success' : 'bg-danger'}">
                        ${restaurant.properties.is_open ? 'Aperto' : 'Chiuso'}
                    </span>
                </div>
            </div>
        </div>
    `).join('');
    
    // Add click handlers
    document.querySelectorAll('.restaurant-list-item').forEach(item => {
        item.style.cursor = 'pointer';
        item.addEventListener('click', function() {
            const restaurantId = this.dataset.restaurantId;
            const restaurant = restaurants.find(r => r.properties.id == restaurantId);
            if (restaurant) {
                showRestaurantModal(restaurant.properties);
                highlightRestaurantOnMap(restaurantId);
            }
        });
    });
}

function highlightRestaurantOnMap(restaurantId) {
    // Remove previous highlights
    document.querySelectorAll('.restaurant-marker').forEach(marker => {
        const circle = marker.querySelector('circle');
        circle.setAttribute('stroke-width', '2');
    });
    
    // Highlight selected restaurant
    const marker = document.querySelector(`[data-restaurant-id="${restaurantId}"]`);
    if (marker) {
        const circle = marker.querySelector('circle');
        circle.setAttribute('stroke-width', '4');
        circle.setAttribute('stroke', '#ffc107');
        
        setTimeout(() => {
            circle.setAttribute('stroke', '#ffffff');
            circle.setAttribute('stroke-width', '2');
        }, 2000);
    }
}

function setupMapControls() {
    const svg = document.getElementById('map-svg');
    const italyMap = document.getElementById('italy-map');
    
    // Pan functionality
    svg.addEventListener('mousedown', startDrag);
    svg.addEventListener('mousemove', drag);
    svg.addEventListener('mouseup', endDrag);
    svg.addEventListener('mouseleave', endDrag);
    
    function startDrag(e) {
        isDragging = true;
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
        svg.style.cursor = 'grabbing';
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        const deltaX = e.clientX - lastMouseX;
        const deltaY = e.clientY - lastMouseY;
        
        mapTranslateX += deltaX;
        mapTranslateY += deltaY;
        
        updateMapTransform();
        
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
    }
    
    function endDrag() {
        isDragging = false;
        svg.style.cursor = 'move';
    }
    
    // Zoom functionality
    svg.addEventListener('wheel', function(e) {
        e.preventDefault();
        
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        mapScale *= delta;
        mapScale = Math.max(0.5, Math.min(mapScale, 3));
        
        updateMapTransform();
    });
}

function updateMapTransform() {
    const italyMap = document.getElementById('italy-map');
    const restaurantsLayer = document.getElementById('restaurants-layer');
    
    const transform = `translate(${mapTranslateX + 50}, ${mapTranslateY + 50}) scale(${mapScale})`;
    italyMap.setAttribute('transform', transform);
    restaurantsLayer.setAttribute('transform', `translate(${mapTranslateX}, ${mapTranslateY}) scale(${mapScale})`);
}

function zoomIn() {
    mapScale *= 1.2;
    mapScale = Math.min(mapScale, 3);
    updateMapTransform();
}

function zoomOut() {
    mapScale *= 0.8;
    mapScale = Math.max(mapScale, 0.5);
    updateMapTransform();
}

function resetView() {
    mapScale = 1;
    mapTranslateX = 0;
    mapTranslateY = 0;
    updateMapTransform();
}

function setupFilters() {
    // Filter buttons
    document.querySelectorAll('input[name="restaurant-filter"]').forEach(radio => {
        radio.addEventListener('change', function() {
            filterRestaurants();
        });
    });
    
    // Search box
    document.getElementById('restaurant-search').addEventListener('input', function() {
        filterRestaurants();
    });
}

function filterRestaurants() {
    const filterValue = document.querySelector('input[name="restaurant-filter"]:checked').value;
    const searchTerm = document.getElementById('restaurant-search').value.toLowerCase();
    
    let filteredRestaurants = restaurantsData.filter(restaurant => {
        const props = restaurant.properties;
        
        // Filter by status
        let statusMatch = true;
        if (filterValue === 'open') statusMatch = props.is_open;
        if (filterValue === 'closed') statusMatch = !props.is_open;
        
        // Filter by search term
        const searchMatch = !searchTerm || 
            props.name.toLowerCase().includes(searchTerm) ||
            props.city.toLowerCase().includes(searchTerm);
        
        return statusMatch && searchMatch;
    });
    
    // Hide/show markers
    document.querySelectorAll('.restaurant-marker').forEach(marker => {
        const restaurantId = marker.dataset.restaurantId;
        const shouldShow = filteredRestaurants.some(r => r.properties.id == restaurantId);
        marker.style.display = shouldShow ? 'block' : 'none';
    });
    
    // Update list
    updateRestaurantsList(filteredRestaurants);
}
</script>

<style>
.restaurant-marker {
    transition: all 0.2s ease;
}

.restaurant-marker:hover {
    filter: drop-shadow(0 0 6px rgba(0,0,0,0.3));
}

#map-svg {
    transition: cursor 0.1s ease;
}

.restaurant-list-item:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-check:checked + .btn {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
}
</style>
{% endblock %}